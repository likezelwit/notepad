<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Garden Notepad ‚Äî Zeli's Garden v5</title>

  <!-- Fonts Google -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;600&family=Poppins:wght@300;400&family=Nunito:wght@400;700&family=Baloo+2&family=Comic+Neue&family=Inter:wght@300;400&family=Caveat:wght@400;700&family=Kalam&family=Gloria+Hallelujah&family=Reenie+Beanie&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Libraries -->
  <script src="https://unpkg.com/picmo@latest/dist/umd/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/openmoji@14.0.0/dist/openmoji.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{
      --sky-1: #e6f9ff;
      --sky-2: #cfeefd;
      --green-1: #f0fbf2;
      --green-2: #dff9e6;
      --green-3: #8ecf9a;
      --accent: #ffd6e0;
      --card: rgba(255,255,255,0.95);
      --muted: #6b6b6b;
      
      /* Editor Vars */
      --paper-bg: #fffaf0;
      --paper-line: rgba(0,0,0,0.05);
      --font-main: 'Quicksand', sans-serif;
      --text-color: #333;
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%; margin:0; font-family:'Quicksand',sans-serif; overflow: hidden; touch-action: pan-y;}

    body{
      background: linear-gradient(180deg,var(--sky-1),var(--sky-2) 40%,var(--green-1) 60%,var(--green-2));
      display:flex; flex-direction: column;
    }

    /* --- HELPERS --- */
    .hidden { display: none !important; }

    /* --- MODE SELECTION --- */
    .mode-selection {
      position: fixed; inset: 0; background: rgba(255,255,255,0.95);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 2000; padding: 20px;
    }
    .mode-options { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-top:20px; }
    .mode-option {
      width: 150px; height: 150px; border-radius: 20px;
      background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.3s;
    }
    .mode-option:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
    .mode-option i { font-size: 48px; margin-bottom: 10px; }

    /* --- APP LAYOUT --- */
    .app {
      width:100%; height:100%; position:relative; 
      background: rgba(255,255,255,0.5); backdrop-filter: blur(5px);
      display: flex; flex-direction: column;
    }

    .header{
      flex: 0 0 80px; padding:0 20px; display:flex; align-items:center; gap:15px;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.0));
      z-index: 100;
    }
    .logo{
      width:45px; height:45px; border-radius:12px; 
      background: linear-gradient(135deg, var(--green-3), var(--green-2));
      display:flex; align-items:center; justify-content:center; 
      font-size:22px; color:#fff; box-shadow:0 4px 10px rgba(0,0,0,0.1);
    }
    
    /* SEARCH BAR */
    .search-bar-container {
      flex: 1; position: relative;
    }
    .search-input {
      width: 100%; padding: 10px 15px 10px 40px; border-radius: 20px;
      border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.8);
      font-family: var(--font-main); outline: none; transition: 0.3s;
    }
    .search-input:focus { background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999; }

    /* AMBIENT BUTTON */
    .ambient-btn {
      width: 40px; height: 40px; border-radius: 50%; border: none;
      background: white; color: var(--green-3); cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center;
      position: relative;
    }
    .ambient-btn.playing { background: var(--accent); color: white; animation: pulse 2s infinite; }
    @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(255, 214, 224, 0.7);} 70% {box-shadow: 0 0 0 10px rgba(255, 214, 224, 0);} 100% {box-shadow: 0 0 0 0 rgba(255, 214, 224, 0);} }

    /* AMBIENT MENU */
    .ambient-menu {
      position: absolute; top: 70px; right: 20px; background: white;
      border-radius: 15px; padding: 10px; width: 180px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 1000;
    }
    .ambient-item {
      padding: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-radius: 8px; font-size: 14px;
    }
    .ambient-item:hover { background: #f0f0f0; }
    .ambient-item.active { background: var(--green-1); color: var(--green-3); font-weight: bold; }

    /* LIST VIEW */
    .notes-list-view {
      flex: 1; overflow-y: auto; padding: 20px;
      display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px;
      padding-bottom: 80px;
    }
    
    @media(min-width: 768px) {
      .notes-list-view { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    }

    .note-card {
      background: var(--card); border-radius: 16px; padding: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer;
      display: flex; flex-direction: column; height: 180px;
      transition: all 0.2s; border: 1px solid rgba(255,255,255,0.5);
      position: relative; overflow: hidden;
    }
    .note-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
    .note-card h3 { margin: 0 0 8px; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 15px; }
    .note-card .preview { font-size: 12px; color: #666; flex: 1; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; line-height: 1.4; }
    .note-card .meta { font-size: 10px; color: #999; margin-top: 10px; display: flex; justify-content: space-between; }
    
    /* Tag & Lock Indicators */
    .card-tag {
      position: absolute; top: 12px; right: 12px; width: 10px; height: 10px; border-radius: 50%;
    }
    .card-lock {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      font-size: 40px; color: rgba(0,0,0,0.05); pointer-events: none;
    }

    .add-btn-card {
      border: 2px dashed var(--green-3); background: rgba(255,255,255,0.4);
      color: var(--green-3); align-items: center; justify-content: center;
      text-align: center; font-size: 14px;
    }
    .delete-card-btn {
      position: absolute; bottom: 10px; right: 10px; border: none; background: white;
      width: 24px; height: 24px; border-radius: 50%; color: #ff8888; cursor: pointer;
      display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      z-index: 5;
    }

    /* --- EDITOR VIEW --- */
    .editor-view {
      position: fixed; inset: 0; background: #f4f9f4;
      display: flex; flex-direction: column;
      transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 50;
    }
    .editor-view.active { transform: translateX(0); }

    .editor-topbar {
      flex: 0 0 60px; padding: 0 10px; display: flex; align-items: center; gap: 10px;
      background: white; border-bottom: 1px solid #eee; z-index: 20;
    }
    .back-btn { border: none; background: transparent; font-size: 18px; padding: 10px; cursor: pointer; color: #555; }
    .note-title-input {
      flex: 1; border: none; font-size: 18px; font-weight: 600; outline: none;
      font-family: 'Quicksand', sans-serif; color: #333; background: transparent;
    }

    /* --- TOP TOOLBAR --- */
    .top-toolbar-container {
      position: absolute; top: 60px; left: 0; width: 100%;
      background: rgba(255,255,255,0.95);
      border-bottom: 1px solid #eee;
      padding: 10px 15px;
      display: flex; align-items: center; justify-content: space-between;
      backdrop-filter: blur(10px);
      z-index: 100;
      box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    }
    
    .scroll-tools {
      display: flex; align-items: center; gap: 15px; overflow-x: auto;
      padding-right: 15px; flex: 1; scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
    }
    .scroll-tools::-webkit-scrollbar { display: none; }

    .tool-btn {
      flex: 0 0 auto; width: 40px; height: 40px; border-radius: 12px;
      border: none; background: #f4f6f4; color: #555;
      font-size: 16px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: 0.2s;
    }
    .tool-btn:active { transform: scale(0.9); }
    .tool-btn.active { background: var(--green-3); color: white; }
    /* Tombol Khusus Drawing */
    .tool-btn.draw-active { background: #ff9800; color: white; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }
    
    .menu-trigger {
      flex: 0 0 auto; width: 45px; height: 45px; border-radius: 14px;
      background: #333; color: white; border: none; font-size: 20px;
      margin-left: 10px; cursor: pointer;
    }

    /* Workspace & Paper */
    .editor-workspace {
      flex: 1; position: relative; overflow-y: auto; overflow-x: hidden;
      display: flex; justify-content: center; 
      background: #eef5ee;
      padding: 20px;
      padding-top: 80px; 
      padding-bottom: 70px;
    }

    .paper-container {
      width: 100%; 
      height: 1760px;
      position: relative;
      background: var(--paper-bg);
      box-shadow: 0 5px 25px rgba(0,0,0,0.05);
      border-radius: 8px;
      max-width: 800px;
      overflow: hidden;
    }

    .paper-pattern {
      position: absolute; inset: 0; pointer-events: none; z-index: 0;
      background-image: repeating-linear-gradient(transparent, transparent 31px, var(--paper-line) 31px, var(--paper-line) 32px);
      background-size: 100% 32px;
      margin-top: 30px;
      height: 1760px;
    }

    /* CANVAS DRAWING LAYER */
    .drawing-layer {
      position: absolute; inset: 0; z-index: 8; 
      pointer-events: none; /* Default: click through to text */
      touch-action: none;
    }
    .paper-container.drawing-mode .drawing-layer { pointer-events: auto; cursor: crosshair; }

    .sticker-layer { position: absolute; inset: 0; overflow: hidden; pointer-events: none; }
    .sticker-layer.front { z-index: 10; }
    .sticker-layer.back { z-index: 1; }

    .rich-editor {
      position: relative; width: 100%; 
      height: 1760px;
      border: none; outline: none; padding: 30px 40px;
      font-size: 16px; line-height: 2;
      font-family: var(--font-main);
      color: var(--text-color);
      background: transparent;
      z-index: 5;
      overflow: hidden;
    }
    
    .paper-container.arrange-mode .rich-editor { pointer-events: none; opacity: 0.6; }

    .rich-editor img { 
      max-width: 300px; max-height: 300px; display: block;
      margin: 10px 0; border-radius: 8px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
      float: left; margin-right: 10px; margin-bottom: 10px; clear: both;
    }
    .rich-editor blockquote { 
      border-left: 4px solid var(--green-3); margin: 10px 0; padding-left: 10px; 
      color: #666; font-style: italic; background: rgba(0,0,0,0.02); 
    }

    /* --- STICKERS --- */
    .sticker {
      position: absolute; display: inline-flex; align-items: center; justify-content: center;
      cursor: grab; user-select: none; touch-action: none; pointer-events: auto;
      transform-origin: center;
    }
    .sticker:active { cursor: grabbing; }
    .sticker-content { font-size: 40px; line-height: 1; pointer-events: none; }
    
    .sticker-controls {
      position: absolute; inset: -15px; border: 2px dashed #8ecf9a; border-radius: 8px;
      display: none; pointer-events: none;
    }
    .sticker.selected .sticker-controls { display: block; }
    
    .ctrl-btn {
      position: absolute; width: 32px; height: 32px; background: white; border: 1px solid #ddd;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 14px; pointer-events: auto; cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 100;
    }
    .ctrl-del { top: -16px; right: -16px; background: #ff6b6b; color: white; border-color: #ff6b6b; }
    .ctrl-layer { bottom: -16px; left: -16px; background: #4D89FF; color: white; border-color: #4D89FF; }
    .ctrl-move { top: -16px; left: 50%; transform: translateX(-50%); background: #4CAF50; color: white; border-color: #4CAF50; }
    
    .ctrl-rotate {
      position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
      width: 24px; height: 24px; background: white; border: 1px solid #ddd;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 12px; color: #555; pointer-events: auto; cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 100;
    }
    
    .ctrl-resize {
      position: absolute; bottom: -8px; right: -8px;
      width: 16px; height: 16px; background: white; border: 1px solid #ddd;
      border-radius: 50%; pointer-events: auto; cursor: se-resize;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 100;
    }

    /* --- MEGA PANEL --- */
    .mega-panel {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 60vh;
      background: white; border-radius: 25px 25px 0 0;
      box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
      z-index: 200; transform: translateY(110%);
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      display: flex; flex-direction: column;
    }
    .mega-panel.open { transform: translateY(0); }

    .panel-header {
      padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
    }
    .panel-tabs {
      display: flex; gap: 5px; overflow-x: auto; padding: 10px 15px;
      border-bottom: 1px solid #eee;
    }
    .tab-btn {
      padding: 8px 14px; border-radius: 20px; border: 1px solid #eee; background: white;
      font-size: 12px; cursor: pointer; white-space: nowrap; color: #555;
    }
    .tab-btn.active { background: var(--green-2); border-color: var(--green-3); color: #2d5a35; font-weight: bold; }
    
    .panel-content { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
    
    .tool-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
    .tool-item {
      display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center;
      padding: 15px 5px; background: #f8f9fa; border-radius: 12px; cursor: pointer;
    }
    .tool-item i { font-size: 20px; color: #666; }
    .tool-item span { font-size: 11px; }

    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 150;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .overlay.active { opacity: 1; pointer-events: auto; }
    
    #emojiContainer { width: 100%; height: 100%; }
    .picmo__picker { width: 100% !important; border: none !important; --emoji-size: 2rem; }
    
    .custom-sticker-upload {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 20px; border: 2px dashed var(--green-3); border-radius: 15px;
      background-color: rgba(142, 207, 154, 0.1); margin-bottom: 20px;
    }
    
    .upload-btn {
      padding: 10px 20px; background-color: var(--green-3); color: white;
      border: none; border-radius: 20px; font-size: 16px; cursor: pointer;
      display: flex; align-items: center; gap: 8px; margin-bottom: 15px;
    }
    
    .custom-sticker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .custom-sticker-item {
      position: relative; height: 60px; background: #f8f9fa; border-radius: 8px;
      display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden;
    }
    .custom-sticker-item img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .delete-sticker-btn {
      position: absolute; top: 5px; right: 5px; background: rgba(255, 0, 0, 0.7);
      color: white; border: none; border-radius: 50%; width: 20px; height: 20px;
      display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px;
    }

    .list-fullscreen-btn {
      position: absolute; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%;
      background: var(--green-3); color: white; border: none; font-size: 20px;
      display: flex; align-items: center; justify-content: center; cursor: pointer; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 10;
    }

    .export-all-btn {
      position: absolute; bottom: 80px; right: 20px; width: 50px; height: 50px; border-radius: 50%;
      background: #ff9800; color: white; border: none; font-size: 20px;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 10;
    }

    .page-nav {
      position: fixed; top: 80px; right: 20px; display: flex; gap: 10px; z-index: 15;
      background: rgba(255,255,255,0.9); padding: 8px 12px; border-radius: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .page-btn {
      width: 36px; height: 36px; border-radius: 50%; background: white; border: 1px solid #ddd;
      display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer;
    }
    .page-btn.active { background: var(--green-3); color: white; border-color: var(--green-3); }
    .page-btn.add-page { background: var(--green-3); color: white; border-color: var(--green-3); }

    .screenshot-btn {
      position: absolute; top: 10px; right: 10px; width: 40px; height: 40px; border-radius: 50%;
      background: var(--green-3); color: white; border: none; font-size: 16px;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10;
    }

    .import-btn {
      position: absolute; bottom: 140px; right: 20px; width: 50px; height: 50px; border-radius: 50%;
      background: #4D89FF; color: white; border: none; font-size: 20px;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 10;
    }

    /* MODAL POPUPS */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000;
      display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s;
    }
    .modal-overlay.active { opacity: 1; pointer-events: auto; }
    .modal-box {
      background: white; border-radius: 15px; padding: 25px; width: 90%; max-width: 350px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center;
    }
    .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
    .num-btn {
      padding: 15px; border-radius: 50%; background: #f4f6f4; border: none; font-size: 18px; font-weight: bold; cursor: pointer;
    }
    .num-btn:active { background: var(--green-3); color: white; }
    .pin-display { font-size: 24px; letter-spacing: 10px; min-height: 40px; margin: 10px 0; font-weight: bold; color: #333; }

    /* UPDATE BADGE */
    .update-list { text-align: left; font-size: 14px; margin: 15px 0; line-height: 1.6; color: #555; }
    .update-list b { color: var(--green-3); }

    /* EXPORT DIALOG */
    .export-dialog {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;
    }
    .export-dialog.hidden { display: none; }
    .export-dialog-content {
      background-color: white; border-radius: 15px; padding: 20px; width: 90%; max-width: 400px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    .export-dialog-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; margin-bottom: 15px; }
    .export-dialog-select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; margin-bottom: 20px; }
    .export-dialog-footer { display: flex; justify-content: flex-end; gap: 10px; }
    .export-dialog-btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; }
    .export-dialog-cancel { background-color: #f0f0f0; color: #666; }
    .export-dialog-confirm { background-color: var(--green-3); color: white; }

    @media(max-width: 767px) {
      .top-toolbar-container {
        position: fixed; bottom: 0; top: auto; border-radius: 20px 20px 0 0; padding-bottom: 20px;
      }
      .editor-workspace { padding-bottom: 120px; }
      .tool-btn { width: 45px; height: 45px; font-size: 18px; }
      .menu-trigger { width: 50px; height: 50px; font-size: 22px; }
      .page-nav { top: 80px; }
    }

    @media(min-width: 600px) {
      .mega-panel { width: 400px; left: 50%; transform: translate(-50%, 110%); height: 500px; border-radius: 15px; bottom: 20px; }
      .mega-panel.open { transform: translate(-50%, 0); }
      .top-toolbar-container { width: 600px; left: 50%; transform: translateX(-50%); border-radius: 0 0 16px 16px; }
    }
    
    @media(max-width: 400px) and (max-height: 600px) {
      .header { flex: 0 0 60px; padding: 0 10px; }
      .logo { width: 35px; height: 35px; font-size: 18px; }
      .title h1 { font-size: 16px; }
      .top-toolbar-container { padding: 5px 10px; height: 50px; }
      .tool-btn { width: 35px; height: 35px; font-size: 14px; }
      .menu-trigger { width: 40px; height: 40px; font-size: 18px; }
      .editor-workspace { padding: 10px; padding-top: 60px; padding-bottom: 60px; }
      .paper-container { height: 1200px; }
      .paper-pattern { height: 1200px; }
      .rich-editor { height: 1200px; padding: 20px; font-size: 14px; }
      .sticker-content { font-size: 30px; }
      .mega-panel { height: 70vh; }
      .page-btn { width: 30px; height: 30px; font-size: 12px; }
      .list-fullscreen-btn, .export-all-btn, .import-btn { width: 40px; height: 40px; font-size: 16px; }
    }
    
    .mobile-portrait .top-toolbar-container {
      position: fixed; bottom: 0; top: auto; border-radius: 20px 20px 0 0; padding-bottom: 20px;
      width: 100%; left: 0; transform: none;
    }
    .mobile-portrait .editor-workspace { padding-bottom: 120px; }
    .mobile-portrait .page-nav { top: 60px; right: 10px; }
    .mobile-portrait .screenshot-btn { top: 5px; right: 5px; width: 30px; height: 30px; font-size: 14px; }
  </style>

</head>
<body>

<!-- Mode Selection Screen -->
<div class="mode-selection" id="modeSelection">
  <h2 class="mode-title">Pilih Mode Penggunaan</h2>
  <div class="mode-options">
    <div class="mode-option" onclick="selectMode('desktop')">
      <i class="fas fa-desktop"></i>
      <span>Desktop</span>
    </div>
    <div class="mode-option" onclick="selectMode('mobile')">
      <i class="fas fa-mobile-alt"></i>
      <span>Mobile</span>
    </div>
  </div>
</div>

<div class="app">
  <div class="header">
    <div class="logo">üåø</div>
    <div class="search-bar-container">
      <i class="fas fa-search search-icon"></i>
      <input type="text" class="search-input" id="searchInput" placeholder="Cari catatan...">
    </div>
    <button class="ambient-btn" id="ambientBtn" onclick="toggleAmbientMenu()">
      <i class="fas fa-music"></i>
    </button>
  </div>

  <div class="ambient-menu hidden" id="ambientMenu">
    <div class="ambient-item" onclick="playAmbient('rain')"><i class="fas fa-cloud-rain"></i> Hujan</div>
    <div class="ambient-item" onclick="playAmbient('lofi')"><i class="fas fa-coffee"></i> Lo-Fi</div>
    <div class="ambient-item" onclick="playAmbient('forest')"><i class="fas fa-tree"></i> Hutan</div>
    <div class="ambient-item" style="border-top:1px solid #eee; margin-top:5px; color:red;" onclick="stopAmbient()"><i class="fas fa-stop"></i> Stop</div>
  </div>

  <div class="notes-list-view" id="notesList"></div>  
  <button class="list-fullscreen-btn" id="listFullscreenBtn" title="Fullscreen"><i class="fas fa-expand"></i></button>
  <button class="export-all-btn" id="listExportAllBtn" title="Export All Notes"><i class="fas fa-download"></i></button>
  <button class="import-btn" id="listImportBtn" title="Import Notes"><i class="fas fa-upload"></i></button>
</div>

<div class="editor-view" id="editorView">
  <div class="editor-topbar">
    <button class="back-btn" id="backBtn"><i class="fas fa-arrow-left"></i></button>
    <input type="text" class="note-title-input" id="noteTitle" placeholder="Judul..." />
    <div id="saveIndicator" style="font-size:11px; color:var(--green-3); font-weight:600; white-space:nowrap;"></div>
    <button class="tool-btn" id="fullscreenBtn" title="Fullscreen"><i class="fas fa-expand"></i></button>
    <button class="tool-btn" id="exportBtn" title="Export"><i class="fas fa-download"></i></button>
    <button class="tool-btn" id="importBtn" title="Import"><i class="fas fa-upload"></i></button>
  </div>

  <div class="top-toolbar-container">
    <div class="scroll-tools">
      <button class="tool-btn" id="addPageBtn" title="Add Page"><i class="fas fa-plus"></i></button>
      <div style="width:1px; height:20px; background:#ddd; margin:0 5px;"></div>
      <button class="tool-btn active" id="modeBtn" onclick="toggleEditMode()"><i class="fas fa-pen"></i></button>
      <button class="tool-btn" id="drawBtn" onclick="toggleDrawingMode()"><i class="fas fa-paint-brush"></i></button>
      <div style="width:1px; height:20px; background:#ddd; margin:0 5px;"></div>
      <button class="tool-btn" onmousedown="evtPd(event)" onclick="execCmd('undo')"><i class="fas fa-undo"></i></button>
      <button class="tool-btn" onmousedown="evtPd(event)" onclick="execCmd('redo')"><i class="fas fa-redo"></i></button>
      <button class="tool-btn" onmousedown="evtPd(event)" onclick="insertCheckbox()"><i class="far fa-check-square"></i></button>
      <button class="tool-btn" onmousedown="evtPd(event)" onclick="insertImagePrompt()"><i class="far fa-image"></i></button>
      <button class="tool-btn" onmousedown="evtPd(event)" onclick="execCmd('bold')"><i class="fas fa-bold"></i></button>
      <button class="tool-btn" onmousedown="evtPd(event)" onclick="execCmd('italic')"><i class="fas fa-italic"></i></button>
      <button class="tool-btn" onmousedown="evtPd(event)" id="alignBtn"><i class="fas fa-align-left"></i></button>
    </div>
    <button class="menu-trigger" onclick="openPanel('stickers')"><i class="fas fa-bars"></i></button>
  </div>

  <div class="editor-workspace">
    <div class="paper-container" id="paperContainer">
      <button class="screenshot-btn" id="screenshotBtn" title="Screenshot"><i class="fas fa-camera"></i></button>
      <div class="paper-pattern" id="paperPattern"></div>
      <canvas id="drawingCanvas" class="drawing-layer" width="800" height="1760"></canvas>
      <div class="sticker-layer back" id="stickerLayerBack"></div>
      <div class="rich-editor" id="richEditor" contenteditable="true" spellcheck="false" placeholder="Tulis sesuatu yang indah..."></div>
      <div class="sticker-layer front" id="stickerLayerFront"></div>
    </div>
    <div class="page-nav" id="pageNav" style="display:none;">
      <button class="page-btn" id="prevPageBtn" title="Previous Page"><i class="fas fa-chevron-left"></i></button>
      <button class="page-btn active" data-page="1">1</button>
      <button class="page-btn add-page" title="Add Page"><i class="fas fa-plus"></i></button>
      <button class="page-btn" id="nextPageBtn" title="Next Page"><i class="fas fa-chevron-right"></i></button>
    </div>
  </div>
</div>

<div class="overlay" id="overlay"></div>

<div class="mega-panel" id="megaPanel">
  <div class="panel-header">
    <h3>Tools & Decor</h3>
    <button id="closePanel" style="border:none;background:none;font-size:24px;">&times;</button>
  </div>
  <div class="panel-tabs">
    <button class="tab-btn active" data-tab="stickers" onmousedown="evtPd(event)">Stickers</button>
    <button class="tab-btn" data-tab="stickers2" onmousedown="evtPd(event)">Custom Stickers</button>
    <button class="tab-btn" data-tab="style" onmousedown="evtPd(event)">Style</button>
    <button class="tab-btn" data-tab="format" onmousedown="evtPd(event)">Format</button>
    <button class="tab-btn" data-tab="paper" onmousedown="evtPd(event)">Paper</button>
    <button class="tab-btn" data-tab="meta" onmousedown="evtPd(event)">Meta & Lock</button>
  </div>
  <div class="panel-content" id="panelContent"></div>
</div>

<!-- Modal PIN -->
<div class="modal-overlay" id="pinModal">
  <div class="modal-box">
    <h3 id="pinTitle">Masukkan PIN</h3>
    <div class="pin-display" id="pinDisplay"></div>
    <div class="numpad">
      <button class="num-btn" onclick="typePin(1)">1</button>
      <button class="num-btn" onclick="typePin(2)">2</button>
      <button class="num-btn" onclick="typePin(3)">3</button>
      <button class="num-btn" onclick="typePin(4)">4</button>
      <button class="num-btn" onclick="typePin(5)">5</button>
      <button class="num-btn" onclick="typePin(6)">6</button>
      <button class="num-btn" onclick="typePin(7)">7</button>
      <button class="num-btn" onclick="typePin(8)">8</button>
      <button class="num-btn" onclick="typePin(9)">9</button>
      <button class="num-btn" style="background:#ffebee;color:#d32f2f;" onclick="clearPin()">C</button>
      <button class="num-btn" onclick="typePin(0)">0</button>
      <button class="num-btn" style="background:#e8f5e9;color:#2e7d32;" onclick="submitPin()">OK</button>
    </div>
    <button onclick="closePinModal()" style="margin-top:15px; border:none; background:transparent; text-decoration:underline;">Batal</button>
  </div>
</div>

<!-- Modal Update -->
<div class="modal-overlay" id="updateModal">
  <div class="modal-box">
    <div style="font-size:40px; margin-bottom:10px;">üéâ</div>
    <h3>Zeli's Garden v5 Update!</h3>
    <ul class="update-list">
      <li>üîç <b>Search Bar:</b> Cari catatanmu dengan mudah.</li>
      <li>üé® <b>Mode Gambar:</b> Coret-coret di atas kertas.</li>
      <li>üîí <b>Kunci PIN:</b> Amankan rahasiamu.</li>
      <li>üéµ <b>Musik:</b> Suara Hujan & Lo-Fi.</li>
      <li>üè∑Ô∏è <b>Label Warna:</b> Tandai catatan penting.</li>
    </ul>
    <button class="tool-btn active" style="width:100%; border-radius:10px;" onclick="closeUpdateModal()">Keren!</button>
  </div>
</div>

<input type="file" id="importFileInput" style="display:none" accept=".json">
<input type="file" id="customStickerInput" style="display:none" accept="image/png,image/webp">

<!-- AUDIO -->
<audio id="sfxClick" preload="auto"><source src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAADhAAzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMz//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAQKAAAAAAAAA4YJCGYZn///////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAQKAAAAAAAAA4YJCGYZn///////////8=" type="audio/mpeg"></audio>
<audio id="sfxPage" preload="auto"><source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBiuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav"></audio>
<audio id="bgmRain" loop><source src="https://cdn.pixabay.com/download/audio/2022/07/04/audio_b95d13735a.mp3" type="audio/mpeg"></audio>
<audio id="bgmLofi" loop><source src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3" type="audio/mpeg"></audio>
<audio id="bgmForest" loop><source src="https://cdn.pixabay.com/download/audio/2021/09/06/audio_3828957802.mp3" type="audio/mpeg"></audio>

<div class="export-dialog hidden" id="exportDialog">
  <div class="export-dialog-content">
    <div class="export-dialog-header">
      <h3 class="export-dialog-title">Export Catatan</h3>
      <button class="export-dialog-close" id="closeExportDialog">&times;</button>
    </div>
    <div class="export-dialog-body">
      <label class="export-dialog-label" for="exportFileName">Nama File:</label>
      <input type="text" class="export-dialog-input" id="exportFileName" placeholder="Nama file...">
      <label class="export-dialog-label" for="exportFileType">Format File:</label>
      <select class="export-dialog-select" id="exportFileType">
        <option value="json">JSON</option>
      </select>
    </div>
    <div class="export-dialog-footer">
      <button class="export-dialog-btn export-dialog-cancel" id="cancelExport">Batal</button>
      <button class="export-dialog-btn export-dialog-confirm" id="confirmExport">Export</button>
    </div>
  </div>
</div>

<script>
  // --- HELPERS ---
  const $ = id => document.getElementById(id);
  const evtPd = e => e.preventDefault();
  
  // --- STATE ---
  const NOTES_KEY = 'zeli_garden_v5';
  const MODE_KEY = 'zeli_garden_mode';
  const CUSTOM_STICKERS_KEY = 'zeli_garden_custom_stickers';
  const VERSION_KEY = 'zeli_version_v5_0';
  
  let notes = JSON.parse(localStorage.getItem(NOTES_KEY) || '[]');
  let customStickers = JSON.parse(localStorage.getItem(CUSTOM_STICKERS_KEY) || '[]');
  let currentNote = null;
  let isNewNote = false;
  let isArrangeMode = false;
  let isDrawingMode = false;
  let selectedSticker = null;
  let savedRange = null; 
  let emojiPicker = null; 
  let openmojiData = []; 
  let isFullscreen = false;
  let isMobileMode = false;
  let styleStates = {}; 
  let currentPage = 1;
  let noteHeight = 1760; 
  let noteWidth = 800; 
  let pageSwitchTimeout = null; 
  let isLoading = false;
  let autoSaveTimer = null;
  let activeAudio = null;
  
  // Lock Vars
  let currentPin = "";
  let tempPinAction = null; 
  let targetNoteId = null;

  // Drawing Vars
  let canvas, ctx;
  let isDrawing = false;
  let lastX = 0, lastY = 0;

  // --- ELEMENTS ---
  const elements = {
    list: $('notesList'), editorView: $('editorView'), 
    editor: $('richEditor'), title: $('noteTitle'),
    paper: $('paperContainer'), pattern: $('paperPattern'),
    layerBack: $('stickerLayerBack'), layerFront: $('stickerLayerFront'),
    panel: $('megaPanel'), panelContent: $('panelContent'), overlay: $('overlay'),
    fullscreenBtn: $('fullscreenBtn'), exportBtn: $('exportBtn'), 
    importBtn: $('importBtn'), importFileInput: $('importFileInput'),
    modeSelection: $('modeSelection'), listFullscreenBtn: $('listFullscreenBtn'),
    pageNav: $('pageNav'), addPageBtn: $('addPageBtn'),
    screenshotBtn: $('screenshotBtn'), customStickerInput: $('customStickerInput'),
    listImportBtn: $('listImportBtn'), listExportAllBtn: $('listExportAllBtn'),
    prevPageBtn: $('prevPageBtn'), nextPageBtn: $('nextPageBtn'),
    exportDialog: $('exportDialog'), exportFileName: $('exportFileName'),
    exportFileType: $('exportFileType'), closeExportDialog: $('closeExportDialog'),
    cancelExport: $('cancelExport'), confirmExport: $('confirmExport'),
    pinModal: $('pinModal'), pinDisplay: $('pinDisplay'), updateModal: $('updateModal')
  };

  // --- INIT ---
  window.addEventListener('DOMContentLoaded', () => {
    // Check Version Update
    if (!localStorage.getItem(VERSION_KEY)) {
      elements.updateModal.classList.add('active');
    }

    const savedMode = localStorage.getItem(MODE_KEY);
    if (savedMode) {
      isMobileMode = savedMode === 'mobile';
      elements.modeSelection.classList.add('hidden');
      renderList();
      initListeners();
      initCanvas();
      loadOpenMojiData();
    } else {
      elements.modeSelection.classList.remove('hidden');
    }
    
    document.addEventListener('touchmove', function(e) { if (e.scale !== 1) e.preventDefault(); }, { passive: false });
    document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
    document.body.addEventListener('touchmove', function(e) { if (e.touches.length > 1) e.preventDefault(); }, { passive: false });
    
    handleOrientationChange();
    window.addEventListener('resize', handleOrientationChange);
    window.addEventListener('orientationchange', handleOrientationChange);
  });

  function selectMode(mode) {
    isMobileMode = mode === 'mobile';
    localStorage.setItem(MODE_KEY, mode);
    elements.modeSelection.classList.add('hidden');
    if (isMobileMode) document.body.classList.add('mobile-mode');
    renderList();
    initListeners();
    initCanvas();
    loadOpenMojiData();
  }

  function closeUpdateModal() {
    localStorage.setItem(VERSION_KEY, 'seen');
    elements.updateModal.classList.remove('active');
  }

  function initListeners() {
    $('backBtn').addEventListener('click', closeEditor);
    elements.editor.addEventListener('input', () => debounceAutoSave());
    elements.title.addEventListener('input', () => debounceAutoSave());
    
    ['keyup', 'mouseup', 'touchend', 'input', 'blur'].forEach(ev => {
      elements.editor.addEventListener(ev, saveSelection);
    });

    $('closePanel').addEventListener('click', closePanel);
    elements.overlay.addEventListener('click', closePanel);
    $('alignBtn').addEventListener('click', toggleAlign);

    elements.fullscreenBtn.addEventListener('click', toggleFullscreen);
    elements.listFullscreenBtn.addEventListener('click', toggleListFullscreen);
    
    elements.exportBtn.addEventListener('click', () => showExportDialog('single'));
    elements.importBtn.addEventListener('click', () => elements.importFileInput.click());
    elements.importFileInput.addEventListener('change', importNotes);
    
    elements.listImportBtn.addEventListener('click', () => elements.importFileInput.click());
    elements.listExportAllBtn.addEventListener('click', () => showExportDialog('all'));

    elements.closeExportDialog.addEventListener('click', hideExportDialog);
    elements.cancelExport.addEventListener('click', hideExportDialog);
    elements.confirmExport.addEventListener('click', performExport);

    // Search Bar Listener
    $('searchInput').addEventListener('keyup', (e) => {
      renderList(e.target.value.toLowerCase());
    });

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        renderPanel(e.target.dataset.tab);
      });
    });

    elements.paper.addEventListener('click', (e) => {
      if(e.target === elements.paper || e.target === elements.editor) deselectSticker();
    });
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (!elements.exportDialog.classList.contains('hidden')) hideExportDialog();
        else if (isFullscreen) {
           if(elements.editorView.classList.contains('active')) toggleFullscreen();
           else toggleListFullscreen();
        }
      }
    });
    
    elements.pageNav.addEventListener('click', (e) => {
      if (e.target.classList.contains('page-btn') && !e.target.id && e.target.dataset.page) {
        const page = parseInt(e.target.dataset.page);
        if (page !== currentPage) switchToPage(page);
      }
    });
    
    elements.prevPageBtn.addEventListener('click', () => {
      playClick();
      if (pageSwitchTimeout) clearTimeout(pageSwitchTimeout);
      pageSwitchTimeout = setTimeout(() => navigatePage('prev'), 300);
    });
    
    elements.nextPageBtn.addEventListener('click', () => {
      playClick();
      if (pageSwitchTimeout) clearTimeout(pageSwitchTimeout);
      pageSwitchTimeout = setTimeout(() => navigatePage('next'), 300);
    });
    
    elements.addPageBtn.addEventListener('click', addNewPage);
    
    elements.screenshotBtn.addEventListener('click', takeScreenshot);
    elements.customStickerInput.addEventListener('change', handleCustomStickerUpload);
    
    elements.editor.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        const lines = elements.editor.innerText.split('\n');
        if (lines.length >= 55) { e.preventDefault(); return false; }
      }
    });

    // Canvas Events
    canvas = $('drawingCanvas');
    ['mousedown', 'touchstart'].forEach(e => canvas.addEventListener(e, startDraw, {passive:false}));
    ['mousemove', 'touchmove'].forEach(e => canvas.addEventListener(e, draw, {passive:false}));
    ['mouseup', 'touchend'].forEach(e => canvas.addEventListener(e, stopDraw));
  }

  function loadOpenMojiData() {
    fetch('https://cdn.jsdelivr.net/npm/openmoji@14.0.0/data/openmoji.json')
      .then(response => response.json())
      .then(data => {
        openmojiData = data.filter(emoji => emoji.skintone === '' && emoji.hasAppleEmoji === true);
      })
      .catch(error => { console.error('Error loading OpenMoji data:', error); });
  }

  // --- DRAWING ENGINE ---
  function initCanvas() {
    canvas = $('drawingCanvas');
    ctx = canvas.getContext('2d');
    canvas.width = 800; canvas.height = 1760;
    ctx.lineJoin = 'round'; ctx.lineCap = 'round'; ctx.lineWidth = 3; ctx.strokeStyle = '#333';
  }

  function toggleDrawingMode() {
    isDrawingMode = !isDrawingMode;
    const btn = $('drawBtn');
    if(isDrawingMode) {
      elements.paper.classList.add('drawing-mode');
      elements.editor.contentEditable = false;
      btn.classList.add('draw-active');
      if(!isArrangeMode) toggleEditMode(); // Turn off text edit mode if active
    } else {
      elements.paper.classList.remove('drawing-mode');
      elements.editor.contentEditable = true;
      btn.classList.remove('draw-active');
      debounceAutoSave();
    }
  }

  function startDraw(e) {
    if(!isDrawingMode) return;
    isDrawing = true;
    const pos = getPos(e);
    lastX = pos.x; lastY = pos.y;
  }

  function draw(e) {
    if(!isDrawing || !isDrawingMode) return;
    e.preventDefault();
    const pos = getPos(e);
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    lastX = pos.x; lastY = pos.y;
  }

  function stopDraw() { 
    if(isDrawing) { isDrawing = false; debounceAutoSave(); }
  }

  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return {
      x: (clientX - rect.left) * (canvas.width / rect.width),
      y: (clientY - rect.top) * (canvas.height / rect.height)
    };
  }

  function clearCanvas() { ctx.clearRect(0,0,canvas.width,canvas.height); }
  
  function loadCanvas(dataUrl) {
    if(!dataUrl) { clearCanvas(); return; }
    const img = new Image();
    img.onload = () => { clearCanvas(); ctx.drawImage(img, 0, 0); };
    img.src = dataUrl;
  }

  // --- AMBIENT SOUND ---
  function toggleAmbientMenu() {
    $('ambientMenu').classList.toggle('hidden');
  }

  function playAmbient(type) {
    stopAmbient();
    const id = type === 'rain' ? 'bgmRain' : type === 'lofi' ? 'bgmLofi' : 'bgmForest';
    activeAudio = $(id);
    activeAudio.volume = 0.5;
    activeAudio.play().catch(e => alert("Tap layar dulu untuk memutar musik"));
    $('ambientBtn').classList.add('playing');
    $('ambientMenu').classList.add('hidden');
  }

  function stopAmbient() {
    if(activeAudio) { activeAudio.pause(); activeAudio.currentTime = 0; }
    $('ambientBtn').classList.remove('playing');
    $('ambientMenu').classList.add('hidden');
  }

  // --- CORE FUNCTIONS ---
  function renderList(searchTerm = '') {
    elements.list.innerHTML = '';
    const addCard = document.createElement('div');
    addCard.className = 'note-card add-btn-card';
    addCard.innerHTML = '<i class="fas fa-plus" style="font-size:30px; margin-bottom:10px;"></i><br>New Story';
    addCard.onclick = createNote;
    elements.list.appendChild(addCard);

    // Filter Logic
    const filteredNotes = notes.filter(note => {
      const content = note.pages && note.pages[1] ? note.pages[1].content : note.content || '';
      const text = (note.title + content).toLowerCase();
      return text.includes(searchTerm);
    });

    filteredNotes.forEach(note => {
      const card = document.createElement('div');
      card.className = 'note-card';
      const prevDiv = document.createElement('div');
      const firstPageContent = note.pages && note.pages[1] ? note.pages[1].content : note.content || '';
      prevDiv.innerHTML = firstPageContent;
      const preview = prevDiv.textContent.substring(0, 120) || 'Kosong...';
      
      const tagHtml = note.tag ? `<div class="card-tag" style="background:${getTagColor(note.tag)}"></div>` : '';
      const lockHtml = note.isLocked ? `<i class="fas fa-lock card-lock"></i>` : '';
      const previewText = note.isLocked ? 'üîí Catatan Terkunci' : preview;

      card.innerHTML = `
        ${tagHtml} ${lockHtml}
        <h3>${note.title || 'Tanpa Judul'}</h3>
        <div class="preview">${previewText}</div>
        <div class="meta">
          <span>${new Date(note.updatedAt).toLocaleDateString()}</span>
          <span>${note.mood || 'üåø'}</span>
        </div>
        <button class="delete-card-btn" onclick="deleteNote('${note.id}', event)"><i class="fas fa-times"></i></button>
      `;
      card.onclick = (e) => { 
        if(!e.target.closest('.delete-card-btn')) checkLockAndOpen(note); 
      };
      elements.list.appendChild(card);
    });
  }

  function getTagColor(tag) {
    if(tag==='Penting') return '#ff6b6b';
    if(tag==='Ide') return '#54a0ff';
    if(tag==='Jurnal') return '#1dd1a1';
    return '#ccc';
  }

  function createNote() {
    isNewNote = true;
    currentNote = {
      id: Date.now().toString(), 
      title: '', content: '', stickers: [], theme: 'default', paper: 'lines', 
      mood: 'üåø', updatedAt: Date.now(), width: noteWidth, height: noteHeight,
      isLocked: false, pin: null, tag: null,
      pages: { 1: { content: '', stickers: [], drawing: null } }
    };
    currentPage = 1;
    loadNoteData();
    isArrangeMode = true; toggleEditMode();
    elements.editorView.classList.add('active');
    setTimeout(() => { elements.editor.focus(); saveSelection(); }, 100);
  }

  function checkLockAndOpen(note) {
    if (note.isLocked) {
      targetNoteId = note.id;
      tempPinAction = 'open';
      $('pinTitle').innerText = "Masukkan PIN";
      openPinModal();
    } else {
      openNote(note.id);
    }
  }

  function openNote(id) {
    isNewNote = false;
    const rawNote = notes.find(n => n.id === id);
    if(!rawNote) return;
    currentNote = JSON.parse(JSON.stringify(rawNote));
    
    if (!currentNote.pages) {
      currentNote.pages = { 1: { content: currentNote.content || '', stickers: currentNote.stickers || [], drawing: null } };
    }
    
    currentPage = 1;
    loadNoteData();
    isArrangeMode = true; toggleEditMode();
    elements.editorView.classList.add('active');
  }

  function loadNoteData() {
    isLoading = true;
    elements.layerBack.innerHTML = '';
    elements.layerFront.innerHTML = '';
    elements.editor.innerHTML = '';
    clearCanvas();
    
    elements.title.value = currentNote.title || '';
    
    const currentPageData = currentNote.pages[currentPage] || { content: '', stickers: [], drawing: null };
    elements.editor.innerHTML = currentPageData.content;
    
    if(currentPageData.drawing) loadCanvas(currentPageData.drawing);

    try {
      applyTheme(currentNote.theme, false);
      applyPaper(currentNote.paper);
    } catch(e) {}
    
    elements.paper.style.width = currentNote.width ? `${currentNote.width}px` : '100%';
    elements.paper.style.height = currentNote.height ? `${currentNote.height}px` : '1760px';
    elements.paper.style.maxWidth = currentNote.width ? `${currentNote.width}px` : '800px';
    
    updatePageNavigation();
    
    if (currentPageData.stickers && Array.isArray(currentPageData.stickers)) {
      currentPageData.stickers.forEach(renderSticker);
    }
    
    savedRange = null;
    setTimeout(() => { isLoading = false; }, 100);
  }

  function debounceAutoSave() {
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(autoSave, 1000);
  }

  function autoSave() {
    if (isLoading || !currentNote) return;
    if (!elements.editorView.classList.contains('active')) return;

    if(!elements.title.value.trim() && elements.editor.innerText.trim()) {
      const words = elements.editor.innerText.trim().split(/\s+/).slice(0, 4).join(' ');
      currentNote.title = words;
    } else {
      currentNote.title = elements.title.value;
    }

    if (!currentNote.pages) currentNote.pages = {};
    if (!currentNote.pages[currentPage]) currentNote.pages[currentPage] = {};
    
    currentNote.pages[currentPage].content = elements.editor.innerHTML;
    currentNote.pages[currentPage].stickers = getStickersData();
    currentNote.pages[currentPage].drawing = canvas.toDataURL(); // Save canvas
    
    if (currentPage === 1) {
      currentNote.content = elements.editor.innerHTML;
      currentNote.stickers = getStickersData();
    }
    
    currentNote.updatedAt = Date.now();
    currentNote.width = noteWidth;
    currentNote.height = noteHeight;

    const idx = notes.findIndex(n => n.id === currentNote.id);
    if(idx > -1) notes[idx] = currentNote;
    else { notes.unshift(currentNote); isNewNote = false; }
    
    localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
    $('saveIndicator').innerText = 'Disimpan...';
    setTimeout(() => { if($('saveIndicator')) $('saveIndicator').innerText = ''; }, 2000);
  }

  function closeEditor() {
    if (!currentNote) return;
    clearTimeout(autoSaveTimer);
    isLoading = true; 
    
    currentNote.title = elements.title.value;
    if (!currentNote.pages[currentPage]) currentNote.pages[currentPage] = {};
    currentNote.pages[currentPage].content = elements.editor.innerHTML;
    currentNote.pages[currentPage].stickers = getStickersData();
    currentNote.pages[currentPage].drawing = canvas.toDataURL();
    currentNote.updatedAt = Date.now();
    
    const idx = notes.findIndex(n => n.id === currentNote.id);
    if(idx > -1) notes[idx] = currentNote;
    else notes.unshift(currentNote);
    
    localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
    elements.editorView.classList.remove('active');
    
    setTimeout(() => {
        elements.editor.innerHTML = '';
        elements.layerBack.innerHTML = '';
        elements.layerFront.innerHTML = '';
        elements.title.value = '';
        currentNote = null;
        isLoading = false; 
    }, 300);

    renderList();
  }

  function deleteNote(id, e) {
    e.stopPropagation();
    if(confirm('Hapus catatan?')) {
      notes = notes.filter(n => n.id !== id);
      localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
      renderList();
    }
  }

  // --- PIN LOGIC ---
  function openPinModal() {
    $('pinModal').classList.add('active');
    currentPin = "";
    updatePinDisplay();
  }
  function closePinModal() { $('pinModal').classList.remove('active'); }
  function typePin(n) {
    if(currentPin.length < 4) { currentPin += n; updatePinDisplay(); }
  }
  function clearPin() { currentPin = ""; updatePinDisplay(); }
  function updatePinDisplay() { $('pinDisplay').innerText = "*".repeat(currentPin.length); }
  
  function submitPin() {
    if(currentPin.length !== 4) return;
    
    if(tempPinAction === 'open') {
      const note = notes.find(n => n.id === targetNoteId);
      if(note && note.pin === currentPin) {
        closePinModal();
        openNote(targetNoteId);
      } else {
        alert('PIN Salah!'); clearPin();
      }
    } else if (tempPinAction === 'lock') {
      currentNote.isLocked = true;
      currentNote.pin = currentPin;
      debounceAutoSave();
      closePinModal();
      alert('Catatan terkunci!');
      closePanel(); 
    }
  }

  function lockCurrentNote() {
    if (currentNote.isLocked) {
      if(confirm("Buka kunci catatan?")) {
        currentNote.isLocked = false;
        currentNote.pin = null;
        debounceAutoSave();
        closePanel();
      }
    } else {
      tempPinAction = 'lock';
      $('pinTitle').innerText = "Buat PIN Baru";
      openPinModal();
    }
  }

  // --- STICKER LOGIC ---
  function addSticker(emoji, isCustom = false, customDataUrl = null) {
    const s = { 
      id: 's'+Date.now(), 
      emoji, x: 100, y: 100, rot: 0, scale: 1.5, layer: 'front',
      page: currentPage, isCustom: isCustom, customDataUrl: customDataUrl
    };
    if (!currentNote.pages[currentPage]) currentNote.pages[currentPage] = { stickers: [] };
    if (!currentNote.pages[currentPage].stickers) currentNote.pages[currentPage].stickers = [];
    currentNote.pages[currentPage].stickers.push(s);
    renderSticker(s);
    clearTimeout(autoSaveTimer); autoSave();
  }

  function renderSticker(data) {
    if (!data.id) return;
    const el = document.createElement('div');
    el.className = 'sticker'; el.id = data.id;
    el.style.left = data.x + 'px'; el.style.top = data.y + 'px';
    el.style.transform = `rotate(${data.rot}deg) scale(${data.scale})`;
    el.dataset.rot = data.rot; el.dataset.scale = data.scale; 
    el.dataset.layer = data.layer; el.dataset.page = data.page || 1;
    
    if (parseInt(el.dataset.page) !== currentPage) el.style.display = 'none';
    
    let stickerContent = data.isCustom ? `<img src="${data.customDataUrl}" style="width: 60px; height: 60px; object-fit: contain;">` : `<div class="sticker-content">${data.emoji}</div>`;
    el.dataset.emoji = data.emoji; el.dataset.isCustom = data.isCustom; el.dataset.customDataUrl = data.customDataUrl;
    
    el.innerHTML = `
      ${stickerContent}
      <div class="sticker-controls">
        <div class="ctrl-btn ctrl-del"><i class="fas fa-times"></i></div>
        <div class="ctrl-btn ctrl-layer"><i class="fas fa-layer-group"></i></div>
        <div class="ctrl-btn ctrl-move"><i class="fas fa-arrows-alt"></i></div>
        <div class="ctrl-rotate"><i class="fas fa-sync-alt"></i></div>
        <div class="ctrl-resize"></div>
      </div>
    `;
    const parent = data.layer === 'back' ? elements.layerBack : elements.layerFront;
    parent.appendChild(el);
    attachStickerEvents(el);
  }

  function attachStickerEvents(el) {
    let startX, startY, startRot, startScale;
    let initialPinchDist = 0; let initialPinchAngle = 0;

    const onStart = (e) => {
      if(e.target.classList.contains('ctrl-btn') || e.target.classList.contains('ctrl-resize')) return;
      selectSticker(el);
      
      if(e.type === 'touchstart' && e.touches.length === 2) {
        e.preventDefault();
        const t1 = e.touches[0]; const t2 = e.touches[1];
        initialPinchDist = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
        initialPinchAngle = Math.atan2(t2.clientY - t1.clientY, t2.clientX - t1.clientX);
        startScale = parseFloat(el.dataset.scale); startRot = parseFloat(el.dataset.rot);
      } else {
        const p = e.type.includes('mouse') ? e : e.touches[0];
        startX = p.clientX; startY = p.clientY;
        el.dataset.startX = el.offsetLeft; el.dataset.startY = el.offsetTop;
      }
      
      document.addEventListener(e.type === 'mousedown' ? 'mousemove' : 'touchmove', onMove, {passive:false});
      document.addEventListener(e.type === 'mousedown' ? 'mouseup' : 'touchend', onEnd);
    };

    const onMove = (e) => {
      if(e.type === 'touchmove' && e.touches.length === 2) {
        e.preventDefault();
        const t1 = e.touches[0]; const t2 = e.touches[1];
        const dist = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
        const angle = Math.atan2(t2.clientY - t1.clientY, t2.clientX - t1.clientX);
        const scaleDiff = (dist / initialPinchDist);
        const newScale = Math.max(0.5, Math.min(5, startScale * scaleDiff));
        const angleDiff = (angle - initialPinchAngle) * (180/Math.PI);
        const newRot = startRot + angleDiff;
        el.style.transform = `rotate(${newRot}deg) scale(${newScale})`;
        el.dataset.scale = newScale; el.dataset.rot = newRot;
      } else if ((e.type === 'mousemove' || e.touches.length === 1)) {
        e.preventDefault();
        const p = e.type.includes('mouse') ? e : e.touches[0];
        const dx = p.clientX - startX; const dy = p.clientY - startY;
        const rect = elements.paper.getBoundingClientRect();
        const stickerRect = el.getBoundingClientRect();
        let newX = parseFloat(el.dataset.startX) + dx;
        let newY = parseFloat(el.dataset.startY) + dy;
        newX = Math.max(0, Math.min(newX, rect.width - stickerRect.width));
        newY = Math.max(0, Math.min(newY, rect.height - stickerRect.height));
        el.style.left = newX + 'px'; el.style.top = newY + 'px';
      }
    };

    const onEnd = () => {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('touchmove', onMove);
      document.removeEventListener('mouseup', onEnd);
      document.removeEventListener('touchend', onEnd);
      clearTimeout(autoSaveTimer); autoSave();
    };

    el.addEventListener('mousedown', onStart);
    el.addEventListener('touchstart', onStart, {passive:false});
    el.addEventListener('dblclick', () => {
      const currentRot = parseFloat(el.dataset.rot) || 0;
      const newRot = currentRot + 45;
      el.style.transform = `rotate(${newRot}deg) scale(${el.dataset.scale})`;
      el.dataset.rot = newRot;
      clearTimeout(autoSaveTimer); autoSave();
    });

    el.querySelector('.ctrl-del').addEventListener('click', (e) => { e.stopPropagation(); el.remove(); clearTimeout(autoSaveTimer); autoSave(); });
    el.querySelector('.ctrl-layer').addEventListener('click', (e) => {
      e.stopPropagation();
      const isFront = el.dataset.layer === 'front';
      el.dataset.layer = isFront ? 'back' : 'front';
      if(isFront) elements.layerBack.appendChild(el); else elements.layerFront.appendChild(el);
      clearTimeout(autoSaveTimer); autoSave();
    });
    
    el.querySelector('.ctrl-move').addEventListener('click', (e) => {
      e.stopPropagation(); selectSticker(el); el.style.cursor = 'move';
      const onMouseMove = (e) => {
        const rect = elements.paper.getBoundingClientRect();
        const x = e.clientX - rect.left - 30; const y = e.clientY - rect.top - 30;
        const maxX = rect.width - 60; const maxY = rect.height - 60;
        el.style.left = Math.max(0, Math.min(x, maxX)) + 'px'; el.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
      };
      const onMouseUp = () => {
        el.style.cursor = 'grab';
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        clearTimeout(autoSaveTimer); autoSave();
      };
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    });
    
    el.querySelector('.ctrl-rotate').addEventListener('mousedown', (e) => {
      e.stopPropagation(); selectSticker(el);
      const rect = el.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2;
      const onRotateMove = (e) => {
        const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * (180 / Math.PI) + 90;
        el.style.transform = `rotate(${angle}deg) scale(${el.dataset.scale})`;
        el.dataset.rot = angle;
      };
      const onRotateEnd = () => {
        document.removeEventListener('mousemove', onRotateMove);
        document.removeEventListener('mouseup', onRotateEnd);
        clearTimeout(autoSaveTimer); autoSave();
      };
      document.addEventListener('mousemove', onRotateMove);
      document.addEventListener('mouseup', onRotateEnd);
    });
    
    el.querySelector('.ctrl-resize').addEventListener('mousedown', (e) => {
      e.stopPropagation(); selectSticker(el);
      const startScale = parseFloat(el.dataset.scale) || 1;
      const startX = e.clientX; const startY = e.clientY;
      const onResizeMove = (e) => {
        const deltaX = e.clientX - startX; const deltaY = e.clientY - startY;
        const delta = Math.max(deltaX, deltaY);
        const newScale = Math.max(0.5, Math.min(5, startScale + (delta / 100)));
        el.style.transform = `rotate(${el.dataset.rot}deg) scale(${newScale})`;
        el.dataset.scale = newScale;
      };
      const onResizeEnd = () => {
        document.removeEventListener('mousemove', onResizeMove);
        document.removeEventListener('mouseup', onResizeEnd);
        clearTimeout(autoSaveTimer); autoSave();
      };
      document.addEventListener('mousemove', onResizeMove);
      document.addEventListener('mouseup', onResizeEnd);
    });
  }

  function getStickersData() {
    const arr = [];
    [elements.layerBack, elements.layerFront].forEach(layer => {
      Array.from(layer.children).forEach(el => {
        const isCustom = el.dataset.isCustom === 'true';
        arr.push({ 
          id: el.id, emoji: isCustom ? null : el.dataset.emoji,
          isCustom: isCustom, customDataUrl: isCustom ? el.dataset.customDataUrl : null,
          x: parseFloat(el.style.left), y: parseFloat(el.style.top), 
          rot: parseFloat(el.dataset.rot), scale: parseFloat(el.dataset.scale), 
          layer: el.dataset.layer, page: parseInt(el.dataset.page) || 1
        });
      });
    });
    return arr;
  }

  // --- FULLSCREEN FUNCTIONS ---
  function toggleFullscreen() {
    isFullscreen = !isFullscreen;
    if (isFullscreen) {
      if (elements.editorView.requestFullscreen) elements.editorView.requestFullscreen();
      else if (elements.editorView.webkitRequestFullscreen) elements.editorView.webkitRequestFullscreen();
      elements.fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
      document.addEventListener('fullscreenchange', handleFullscreenChange);
    } else {
      if (document.exitFullscreen) document.exitFullscreen();
      elements.fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
    }
  }

  function toggleListFullscreen() {
    isFullscreen = !isFullscreen;
    if (isFullscreen) {
      if (document.body.requestFullscreen) document.body.requestFullscreen();
      elements.listFullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
      document.addEventListener('fullscreenchange', handleFullscreenChange);
    } else {
      if (document.exitFullscreen) document.exitFullscreen();
      elements.listFullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
    }
  }

  function handleFullscreenChange() {
    const isCurrentlyFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement);
    if (!isCurrentlyFullscreen && isFullscreen) {
      isFullscreen = false;
      elements.fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
      elements.listFullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
    }
  }

  // --- EXPORT/IMPORT FUNCTIONS ---
  function showExportDialog(type) {
    if (type === 'single' && currentNote) elements.exportFileName.value = `${currentNote.title || 'Tanpa_Judul'}.json`;
    else if (type === 'all') elements.exportFileName.value = `AllNotes_GardenNotepad.json`;
    elements.exportDialog.dataset.exportType = type;
    elements.exportDialog.classList.remove('hidden');
  }
  
  function hideExportDialog() { elements.exportDialog.classList.add('hidden'); }
  
  function performExport() {
    const type = elements.exportDialog.dataset.exportType;
    const fileName = elements.exportFileName.value.trim();
    if (!fileName) { alert('Silakan masukkan nama file.'); return; }
    
    const exportData = {
      version: "1.0", exportDate: new Date().toISOString(),
      appInfo: { name: "Zeli's Garden v4" },
      customStickers: customStickers
    };
    
    if (type === 'single' && currentNote) exportData.note = currentNote;
    else if (type === 'all') exportData.notes = notes;
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const link = document.createElement('a');
    link.href = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    link.download = fileName;
    link.click();
    hideExportDialog();
  }

  function importNotes(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const importedData = JSON.parse(event.target.result);
        if (importedData.notes || importedData.note) {
          const merge = confirm('Gabungkan dengan catatan yang ada? (OK = Gabung, Cancel = Timpa)');
          if (merge) {
            const existingIds = new Set(notes.map(n => n.id));
            const newNotes = importedData.notes ? importedData.notes : [importedData.note];
            newNotes.forEach(n => { if (!existingIds.has(n.id)) notes.push(n); });
          } else {
            notes = importedData.notes ? importedData.notes : [importedData.note];
          }
          localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
          renderList();
          alert('Import berhasil!');
        }
      } catch (error) { alert('Error: ' + error.message); }
      e.target.value = '';
    };
    reader.readAsText(file);
  }

  // --- CUSTOM STICKER ---
  function handleCustomStickerUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.type.match('image/png') && !file.type.match('image/webp')) { alert('Gunakan PNG/WEBP'); return; }
    
    const reader = new FileReader();
    reader.onload = function(event) {
      customStickers.push({
        id: 'custom_' + Date.now(), name: file.name,
        dataUrl: event.target.result, uploadDate: new Date().toISOString()
      });
      localStorage.setItem(CUSTOM_STICKERS_KEY, JSON.stringify(customStickers));
      renderPanel('stickers2');
      alert('Stiker tersimpan!');
    };
    reader.readAsDataURL(file);
    e.target.value = '';
  }
  
  function deleteCustomSticker(id) {
    if (confirm('Hapus stiker ini?')) {
      customStickers = customStickers.filter(s => s.id !== id);
      localStorage.setItem(CUSTOM_STICKERS_KEY, JSON.stringify(customStickers));
      renderPanel('stickers2');
    }
  }

  // --- EDITOR UTILS ---
  function saveSelection() {
    if(isArrangeMode) return;
    const sel = window.getSelection();
    if(sel.rangeCount > 0) {
      const range = sel.getRangeAt(0);
      if(elements.editor.contains(range.commonAncestorContainer)) savedRange = range;
    }
  }
  function restoreSelection() {
    elements.editor.focus();
    if(savedRange) { window.getSelection().removeAllRanges(); window.getSelection().addRange(savedRange); }
  }
  function execCmd(cmd, val=null) { restoreSelection(); document.execCommand(cmd, false, val); saveSelection(); debounceAutoSave(); }
  
  function toggleEditMode() {
    isArrangeMode = !isArrangeMode;
    const btn = $('modeBtn');
    if(isArrangeMode) {
      elements.paper.classList.add('arrange-mode'); elements.editor.contentEditable = false;
      btn.innerHTML = '<i class="fas fa-hand-pointer"></i>'; btn.classList.remove('active');
    } else {
      elements.paper.classList.remove('arrange-mode'); elements.editor.contentEditable = true;
      btn.innerHTML = '<i class="fas fa-pen"></i>'; btn.classList.add('active');
      restoreSelection();
      // Disable Drawing if active
      if(isDrawingMode) toggleDrawingMode();
    }
  }

  function toggleAlign() {
    restoreSelection();
    const modes = ['justifyLeft', 'justifyCenter', 'justifyRight'];
    const icons = ['fa-align-left', 'fa-align-center', 'fa-align-right'];
    let idx = parseInt($('alignBtn').dataset.idx || 0); idx = (idx + 1) % 3;
    document.execCommand(modes[idx]);
    $('alignBtn').dataset.idx = idx; $('alignBtn').innerHTML = `<i class="fas ${icons[idx]}"></i>`;
    saveSelection();
  }

  function insertCheckbox() { execCmd('insertHTML', '<input type="checkbox" style="vertical-align:middle; margin-right:5px;">&nbsp;'); }
  
  function insertImagePrompt() {
    const input = document.createElement('input'); input.type='file'; input.accept='image/*';
    input.onchange = e => {
      const f = e.target.files[0];
      if(f) {
        const r = new FileReader();
        r.onload = ev => { 
          execCmd('insertHTML', `<img src="${ev.target.result}" style="max-width:300px; max-height:300px; display:block; margin:10px 0; border-radius:8px; float:left; margin-right:10px;">`); 
        };
        r.readAsDataURL(f);
      }
    };
    input.click();
  }

  function selectSticker(el) {
    if(selectedSticker) selectedSticker.classList.remove('selected');
    selectedSticker = el; el.classList.add('selected');
  }
  function deselectSticker() {
    if(selectedSticker) { selectedSticker.classList.remove('selected'); selectedSticker = null; }
  }

  // --- PAGE MANAGEMENT ---
  function updatePageNavigation() {
    if (!currentNote) return;
    const pages = Object.keys(currentNote.pages || {}).length;
    elements.pageNav.style.display = pages > 1 ? 'flex' : 'none';
    const pageButtons = elements.pageNav.querySelectorAll('.page-btn[data-page]');
    pageButtons.forEach(btn => {
      const pageNum = parseInt(btn.dataset.page);
      if (pageNum === currentPage) btn.classList.add('active'); else btn.classList.remove('active');
    });
  }

  function switchToPage(pageNum) {
    if (!currentNote) return;
    clearTimeout(autoSaveTimer); autoSave();
    currentPage = pageNum;
    updatePageNavigation();
    loadNoteData();
  }

  function navigatePage(direction) {
    if (!currentNote) return;
    const pageNumbers = Object.keys(currentNote.pages || {}).map(Number).sort((a, b) => a - b);
    if (pageNumbers.length <= 1) return;
    const currentIndex = pageNumbers.indexOf(currentPage);
    if (direction === 'prev' && currentIndex > 0) { switchToPage(pageNumbers[currentIndex - 1]); playPage(); }
    else if (direction === 'next' && currentIndex < pageNumbers.length - 1) { switchToPage(pageNumbers[currentIndex + 1]); playPage(); }
  }

  function addNewPage() {
    if (!currentNote) return;
    clearTimeout(autoSaveTimer); autoSave();
    const pageNumbers = Object.keys(currentNote.pages || {}).map(Number);
    const newPageNum = pageNumbers.length > 0 ? Math.max(...pageNumbers) + 1 : 1;
    if (!currentNote.pages) currentNote.pages = {};
    currentNote.pages[newPageNum] = { content: '', stickers: [], drawing: null };
    currentPage = newPageNum;
    updatePageNavigation();
    loadNoteData();
    clearTimeout(autoSaveTimer); autoSave();
  }

  function takeScreenshot() {
    clearTimeout(autoSaveTimer); autoSave();
    html2canvas(elements.paper, { useCORS: true, allowTaint: true, backgroundColor: null }).then(canvas => {
      canvas.toBlob(blob => {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `zeli_page_${currentPage}.png`;
        link.click();
      });
    });
  }

  // --- PANELS ---
  function openPanel(tab) {
    saveSelection();
    elements.panel.classList.add('open'); elements.overlay.classList.add('active');
    document.querySelector(`.tab-btn[data-tab="${tab}"]`).click();
  }
  function closePanel() {
    elements.panel.classList.remove('open'); elements.overlay.classList.remove('active');
    if(!isArrangeMode) restoreSelection();
  }

  function renderPanel(tab) {
    elements.panelContent.innerHTML = '';
    if(tab === 'stickers') {
      const container = document.createElement('div'); container.id = 'emojiContainer';
      elements.panelContent.appendChild(container);
      emojiPicker = picmo.createPicker({ rootElement: container, native: true });
      emojiPicker.addEventListener('emoji:select', s => { addSticker(s.emoji); closePanel(); });
    } 
    else if(tab === 'stickers2') {
      elements.panelContent.innerHTML = `
        <div class="custom-sticker-upload">
          <button class="upload-btn" onclick="document.getElementById('customStickerInput').click()"><i class="fas fa-upload"></i> Upload</button>
          <div class="upload-tips">Format: PNG / WEBP (Transparan)</div>
          <a href="https://www.flaticon.com/stickers" target="_blank" class="flaticon-link"><i class="fas fa-external-link-alt"></i> Flaticon</a>
        </div>`;
      if (customStickers.length > 0) {
        const grid = document.createElement('div'); grid.className = 'custom-sticker-grid';
        customStickers.forEach(s => {
          const item = document.createElement('div'); item.className = 'custom-sticker-item';
          item.innerHTML = `<img src="${s.dataUrl}"><button class="delete-sticker-btn" onclick="deleteCustomSticker('${s.id}')"><i class="fas fa-times"></i></button>`;
          item.onclick = (e) => { if(!e.target.closest('.delete-sticker-btn')) { addSticker(null, true, s.dataUrl); closePanel(); }};
          grid.appendChild(item);
        });
        elements.panelContent.appendChild(grid);
      }
    }
    else if(tab === 'style') {
      const fonts = ['Quicksand', 'Caveat', 'Kalam', 'Sacramento', 'Dancing Script', 'Indie Flower', 'Courier New'];
      let h = `<div class="tool-grid">`;
      fonts.forEach(f => {
        const isActive = styleStates[f] === true;
        h += `<div class="tool-item ${isActive ? 'active' : ''}" onmousedown="evtPd(event)" onclick="toggleFont('${f}')" style="font-family:${f}; font-size:16px;">Aa<br><span>${f}</span></div>`;
      });
      h += `</div><hr style="margin:15px 0; border-top:1px solid #eee;">`;
      h += `<div class="tool-grid">
         <div class="tool-item" onmousedown="evtPd(event)" onclick="toggleStyle('fontSize', 3)">Norm</div>
         <div class="tool-item" onmousedown="evtPd(event)" onclick="toggleStyle('fontSize', 5)">Big</div>
         <div class="tool-item" onmousedown="evtPd(event)" onclick="toggleStyle('hiliteColor', '#ffd6e0')"><span style="background:#ffd6e0">Hilite</span></div>
      </div>`;
      elements.panelContent.innerHTML = h;
    }
    else if(tab === 'format') {
       elements.panelContent.innerHTML = `
        <div class="tool-grid">
          <div class="tool-item" onmousedown="evtPd(event)" onclick="execCmd('insertUnorderedList'); closePanel();"><i class="fas fa-list-ul"></i><span>List</span></div>
          <div class="tool-item" onmousedown="evtPd(event)" onclick="execCmd('insertOrderedList'); closePanel();"><i class="fas fa-list-ol"></i><span>123</span></div>
          <div class="tool-item" onmousedown="evtPd(event)" onclick="execCmd('insertHorizontalRule'); closePanel();"><i class="fas fa-minus"></i><span>Line</span></div>
          <div class="tool-item" onmousedown="evtPd(event)" onclick="insertQuote(); closePanel();"><i class="fas fa-quote-right"></i><span>Quote</span></div>
        </div>`;
    }
    else if(tab === 'paper') {
       elements.panelContent.innerHTML = `
        <div class="tool-grid">
          <div class="tool-item" onmousedown="evtPd(event)" onclick="applyPaper('lines'); closePanel();"><i class="fas fa-bars"></i><span>Garis</span></div>
          <div class="tool-item" onmousedown="evtPd(event)" onclick="applyPaper('grid'); closePanel();"><i class="fas fa-border-all"></i><span>Kotak</span></div>
          <div class="tool-item" onmousedown="evtPd(event)" onclick="applyPaper('plain'); closePanel();"><i class="far fa-file"></i><span>Polos</span></div>
        </div>`;
    }
    else if(tab === 'meta') {
       elements.panelContent.innerHTML = `
        <div class="tool-grid">
           <div class="tool-item" onmousedown="evtPd(event)" onclick="lockCurrentNote()"><i class="fas fa-lock"></i><span>${currentNote.isLocked ? 'Buka Kunci' : 'Kunci PIN'}</span></div>
           <div class="tool-item" onmousedown="evtPd(event)" onclick="setTag('Penting')"><i class="fas fa-circle" style="color:#ff6b6b"></i><span>Penting</span></div>
           <div class="tool-item" onmousedown="evtPd(event)" onclick="setTag('Ide')"><i class="fas fa-circle" style="color:#54a0ff"></i><span>Ide</span></div>
           <div class="tool-item" onmousedown="evtPd(event)" onclick="setTag('Jurnal')"><i class="fas fa-circle" style="color:#1dd1a1"></i><span>Jurnal</span></div>
        </div>
        <div style="text-align:center; font-size:11px; margin-top:10px; color:#666;">
           Count: ${elements.editor.innerText.split(' ').length} Words
        </div>`;
    }
  }

  function setTag(tag) {
    currentNote.tag = tag;
    debounceAutoSave();
    alert('Tag diset: ' + tag);
    closePanel();
  }

  function toggleFont(font) {
    restoreSelection();
    document.execCommand('fontName', false, styleStates[font] ? 'Quicksand' : font);
    styleStates[font] = !styleStates[font];
    renderPanel('style'); closePanel(); debounceAutoSave();
  }

  function toggleStyle(cmd, val) {
    restoreSelection(); document.execCommand(cmd, false, val);
    renderPanel('style'); closePanel(); debounceAutoSave();
  }

  function insertQuote() { execCmd('insertHTML', '<blockquote>Quote</blockquote>'); }

  function applyTheme(id, save=true) {
    if(save) { currentNote.theme = id; debounceAutoSave(); }
    const t = {
      'default': { bg:'#fffaf0', col:'#333', font:'Quicksand'},
      'dark': { bg:'#2d2d2d', col:'#e0e0e0', font:'Inter'},
      'pink': { bg:'#fff0f5', col:'#880e4f', font:'Caveat'},
      'blue': { bg:'#f0f8ff', col:'#01579b', font:'Nunito'}
    }[id] || {bg:'#fffaf0'};
    elements.paper.style.backgroundColor = t.bg;
    elements.editor.style.color = t.col;
    if(save) { elements.editor.style.fontFamily = t.font; closePanel(); }
  }

  function applyPaper(type) {
    currentNote.paper = type;
    const c = currentNote.theme === 'dark' ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';
    let bg = '';
    if(type === 'lines') bg = `repeating-linear-gradient(transparent, transparent 31px, ${c} 31px, ${c} 32px)`;
    if(type === 'grid') bg = `linear-gradient(${c} 1px, transparent 1px), linear-gradient(90deg, ${c} 1px, transparent 1px)`;
    elements.pattern.style.backgroundImage = bg;
    elements.pattern.style.backgroundSize = type === 'grid' ? '20px 20px' : '100% 32px';
    debounceAutoSave(); closePanel();
  }

  function playClick() { document.getElementById('sfxClick').play().catch(()=>{}); }
  function playPage() { document.getElementById('sfxPage').play().catch(()=>{}); }
  
  function handleOrientationChange() {
    if (window.matchMedia("(orientation: portrait)").matches && window.innerWidth <= 400) {
      document.body.classList.add('mobile-portrait');
    } else {
      document.body.classList.remove('mobile-portrait');
    }
  }
</script>

</body>
</html>
