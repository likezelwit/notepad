<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Garden Notepad â€” Zeli's Garden</title>
  
  <!-- Fonts Google -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;600&family=Poppins:wght@300;400&family=Nunito:wght@400;700&family=Baloo+2&family=Comic+Neue&family=Inter:wght@300;400&family=Caveat:wght@400;700&family=Kalam&family=Gloria+Hallelujah&family=Reenie+Beanie&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Picmo Emoji Picker CDN -->
  <script src="https://unpkg.com/picmo@latest/dist/umd/index.js"></script>

  <style>
    :root{
      --sky-1: #e6f9ff;
      --sky-2: #cfeefd;
      --green-1: #f0fbf2;
      --green-2: #dff9e6;
      --green-3: #8ecf9a;
      --accent: #ffd6e0;
      --card: rgba(255,255,255,0.95);
      --muted: #6b6b6b;
      
      /* Editor Vars */
      --paper-bg: #fffaf0;
      --paper-line: rgba(0,0,0,0.05);
      --font-main: 'Quicksand', sans-serif;
      --text-color: #333;
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%; margin:0; font-family:'Quicksand',sans-serif; overflow: hidden;}

    body{
      background: linear-gradient(180deg,var(--sky-1),var(--sky-2) 40%,var(--green-1) 60%,var(--green-2));
      display:flex; flex-direction: column;
    }

    /* --- LIST VIEW --- */
    .app {
      width:100%; height:100%; position:relative; 
      background: rgba(255,255,255,0.5); backdrop-filter: blur(5px);
      display: flex; flex-direction: column;
    }

    .header{
      flex: 0 0 80px; padding:0 20px; display:flex; align-items:center; gap:15px;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.0));
    }
    .logo{
      width:45px; height:45px; border-radius:12px; 
      background: linear-gradient(135deg, var(--green-3), var(--green-2));
      display:flex; align-items:center; justify-content:center; 
      font-size:22px; color:#fff; box-shadow:0 4px 10px rgba(0,0,0,0.1);
    }
    .title h1{ margin:0; font-size:18px; color:#333; }
    .title p{ margin:0; color:var(--muted); font-size:12px; }

    .notes-list-view {
      flex: 1; overflow-y: auto; padding: 20px;
      display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px;
      padding-bottom: 80px;
    }
    
    @media(min-width: 768px) {
      .notes-list-view { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    }

    .note-card {
      background: var(--card); border-radius: 16px; padding: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer;
      display: flex; flex-direction: column; height: 180px;
      transition: all 0.2s; border: 1px solid rgba(255,255,255,0.5);
      position: relative;
    }
    .note-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
    .note-card h3 { margin: 0 0 8px; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .note-card .preview { font-size: 12px; color: #666; flex: 1; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; line-height: 1.4; }
    .note-card .meta { font-size: 10px; color: #999; margin-top: 10px; display: flex; justify-content: space-between; }
    
    .add-btn-card {
      border: 2px dashed var(--green-3); background: rgba(255,255,255,0.4);
      color: var(--green-3); align-items: center; justify-content: center;
      text-align: center; font-size: 14px;
    }
    .delete-card-btn {
      position: absolute; top: 8px; right: 8px; border: none; background: #fff;
      width: 24px; height: 24px; border-radius: 50%; color: #ff8888; cursor: pointer;
      display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      z-index: 5;
    }

    /* --- EDITOR VIEW --- */
    .editor-view {
      position: fixed; inset: 0; background: #f4f9f4;
      display: flex; flex-direction: column;
      transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 50;
    }
    .editor-view.active { transform: translateX(0); }

    .editor-topbar {
      flex: 0 0 60px; padding: 0 10px; display: flex; align-items: center; gap: 10px;
      background: white; border-bottom: 1px solid #eee; z-index: 20;
    }
    .back-btn { border: none; background: transparent; font-size: 18px; padding: 10px; cursor: pointer; color: #555; }
    .note-title-input {
      flex: 1; border: none; font-size: 18px; font-weight: 600; outline: none;
      font-family: 'Quicksand', sans-serif; color: #333; background: transparent;
    }

    /* Workspace & Paper */
    .editor-workspace {
      flex: 1; position: relative; overflow-y: auto; overflow-x: hidden;
      display: flex; justify-content: center; 
      background: #eef5ee;
      padding: 20px;
      /* PENTING: Padding bawah agar teks tidak tertutup toolbar */
      padding-bottom: 100px; 
    }

    .paper-container {
      width: 100%; height: auto; min-height: 100%;
      position: relative;
      background: var(--paper-bg);
      box-shadow: 0 5px 25px rgba(0,0,0,0.05);
      border-radius: 8px;
      /* Desktop Style A4 look */
      max-width: 800px;
      overflow: hidden; /* Contains stickers inside paper */
    }

    .paper-pattern {
      position: absolute; inset: 0; pointer-events: none; z-index: 0;
      background-image: repeating-linear-gradient(transparent, transparent 31px, var(--paper-line) 31px, var(--paper-line) 32px);
      background-size: 100% 32px;
      margin-top: 30px;
    }

    .sticker-layer { position: absolute; inset: 0; overflow: hidden; pointer-events: none; }
    .sticker-layer.front { z-index: 10; }
    .sticker-layer.back { z-index: 1; }

    .rich-editor {
      position: relative; width: 100%; min-height: 80vh;
      border: none; outline: none; padding: 30px 40px;
      font-size: 16px; line-height: 2;
      font-family: var(--font-main);
      color: var(--text-color);
      background: transparent;
      z-index: 5;
    }
    
    .paper-container.arrange-mode .rich-editor { pointer-events: none; opacity: 0.6; }

    .rich-editor img { max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin: 10px 0; }
    .rich-editor blockquote { 
      border-left: 4px solid var(--green-3); margin: 10px 0; padding-left: 10px; 
      color: #666; font-style: italic; background: rgba(0,0,0,0.02); 
    }
    .highlight-pastel { background: #ffd6e0; border-radius: 4px; padding: 0 4px; }

    /* --- STICKERS --- */
    .sticker {
      position: absolute; display: inline-flex; align-items: center; justify-content: center;
      cursor: grab; user-select: none; touch-action: none; pointer-events: auto;
      transform-origin: center;
    }
    .sticker:active { cursor: grabbing; }
    .sticker-content { font-size: 40px; line-height: 1; pointer-events: none; }
    
    /* Control Handles (Only visible on Desktop or when selected) */
    .sticker-controls {
      position: absolute; inset: -15px; border: 2px dashed #8ecf9a; border-radius: 8px;
      display: none; pointer-events: none;
    }
    .sticker.selected .sticker-controls { display: block; }
    
    .ctrl-btn {
      position: absolute; width: 32px; height: 32px; background: white; border: 1px solid #ddd;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 14px; color: #555; pointer-events: auto; cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 100;
    }
    .ctrl-del { top: -16px; right: -16px; color: #ff6b6b; }
    .ctrl-layer { bottom: -16px; left: -16px; color: #4D89FF; }

    /* --- TOOLBAR OPTIMIZATION --- */
    .toolbar-container {
      position: absolute; bottom: 0; left: 0; width: 100%;
      background: rgba(255,255,255,0.95);
      border-top: 1px solid #eee;
      padding: 10px 15px;
      display: flex; align-items: center; justify-content: space-between;
      backdrop-filter: blur(10px);
      z-index: 100;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
    }
    
    .scroll-tools {
      display: flex; align-items: center; gap: 15px; overflow-x: auto;
      padding-right: 15px; flex: 1; scrollbar-width: none;
    }
    .scroll-tools::-webkit-scrollbar { display: none; }

    .tool-btn {
      flex: 0 0 auto; width: 40px; height: 40px; border-radius: 12px;
      border: none; background: #f4f6f4; color: #555;
      font-size: 16px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: 0.2s;
    }
    .tool-btn:active { transform: scale(0.9); }
    .tool-btn.active { background: var(--green-3); color: white; }
    
    /* Tombol Mega Menu (Kotak) */
    .menu-trigger {
      flex: 0 0 auto; width: 45px; height: 45px; border-radius: 14px;
      background: #333; color: white; border: none; font-size: 20px;
      margin-left: 10px; cursor: pointer;
    }

    /* --- MEGA PANEL --- */
    .mega-panel {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 60vh;
      background: white; border-radius: 25px 25px 0 0;
      box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
      z-index: 200; transform: translateY(110%);
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      display: flex; flex-direction: column;
    }
    .mega-panel.open { transform: translateY(0); }

    .panel-header {
      padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
    }
    .panel-tabs {
      display: flex; gap: 5px; overflow-x: auto; padding: 10px 15px;
      border-bottom: 1px solid #eee;
    }
    .tab-btn {
      padding: 8px 14px; border-radius: 20px; border: 1px solid #eee; background: white;
      font-size: 12px; cursor: pointer; white-space: nowrap; color: #555;
    }
    .tab-btn.active { background: var(--green-2); border-color: var(--green-3); color: #2d5a35; font-weight: bold; }
    
    .panel-content { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
    
    /* Grid Tools inside Panel */
    .tool-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
    .tool-item {
      display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center;
      padding: 15px 5px; background: #f8f9fa; border-radius: 12px; cursor: pointer;
    }
    .tool-item i { font-size: 20px; color: #666; }
    .tool-item span { font-size: 11px; }

    /* Theme Cards */
    .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .theme-card {
      padding: 15px; border-radius: 10px; color: white; cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
    }

    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 150;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .overlay.active { opacity: 1; pointer-events: auto; }
    
    /* PICMO Container Style */
    #emojiContainer {
      width: 100%; height: 100%;
    }
    /* Fix Picmo sizing */
    .picmo__picker { width: 100% !important; border: none !important; --emoji-size: 2rem; }

    @media(min-width: 600px) {
      .mega-panel { width: 400px; left: 50%; transform: translate(-50%, 110%); height: 500px; border-radius: 15px; bottom: 20px; }
      .mega-panel.open { transform: translate(-50%, 0); }
      .toolbar-container { width: 600px; left: 50%; transform: translateX(-50%); border-radius: 16px 16px 0 0; bottom: 0; }
    }
  </style>
</head>
<body>

<div class="app">
  <div class="header">
    <div class="logo">ðŸŒ¿</div>
    <div class="title">
      <h1>Zeli's Garden v4</h1>
      <p>Estetika & Emosi</p>
    </div>
  </div>

  <div class="notes-list-view" id="notesList"></div>
</div>

<div class="editor-view" id="editorView">
  <div class="editor-topbar">
    <button class="back-btn" id="backBtn"><i class="fas fa-arrow-left"></i></button>
    <input type="text" class="note-title-input" id="noteTitle" placeholder="Judul..." />
    <div id="saveIndicator" style="font-size:11px; color:var(--green-3); font-weight:600; white-space:nowrap;"></div>
  </div>

  <div class="editor-workspace">
    <div class="paper-container" id="paperContainer">
      <div class="paper-pattern" id="paperPattern"></div>
      <div class="sticker-layer back" id="stickerLayerBack"></div>
      <div class="rich-editor" id="richEditor" contenteditable="true" spellcheck="false" placeholder="Tulis sesuatu yang indah..."></div>
      <div class="sticker-layer front" id="stickerLayerFront"></div>
    </div>
  </div>

  <!-- Optimized Toolbar -->
  <div class="toolbar-container">
    <div class="scroll-tools">
      <button class="tool-btn active" id="modeBtn" onclick="toggleEditMode()"><i class="fas fa-pen"></i></button>
      <div style="width:1px; height:20px; background:#ddd; margin:0 5px;"></div>
      
      <!-- Common tools outside mega menu -->
      <button class="tool-btn" onmousedown="evtPd(event)" onclick="execCmd('undo')"><i class="fas fa-undo"></i></button>
      <button class="tool-btn" onmousedown="evtPd(event)" onclick="execCmd('redo')"><i class="fas fa-redo"></i></button>
      <button class="tool-btn" onmousedown="evtPd(event)" onclick="insertCheckbox()"><i class="far fa-check-square"></i></button>
      <button class="tool-btn" onmousedown="evtPd(event)" onclick="insertImagePrompt()"><i class="far fa-image"></i></button>
      <button class="tool-btn" onmousedown="evtPd(event)" onclick="execCmd('bold')"><i class="fas fa-bold"></i></button>
      <button class="tool-btn" onmousedown="evtPd(event)" onclick="execCmd('italic')"><i class="fas fa-italic"></i></button>
      <button class="tool-btn" onmousedown="evtPd(event)" id="alignBtn"><i class="fas fa-align-left"></i></button>
    </div>
    <button class="menu-trigger" onclick="openPanel('stickers')"><i class="fas fa-bars"></i></button>
  </div>
</div>

<div class="overlay" id="overlay"></div>

<div class="mega-panel" id="megaPanel">
  <div class="panel-header">
    <h3>Tools & Decor</h3>
    <button id="closePanel" style="border:none;background:none;font-size:24px;">&times;</button>
  </div>
  
  <div class="panel-tabs">
    <button class="tab-btn active" data-tab="stickers" onmousedown="evtPd(event)">Stickers</button>
    <button class="tab-btn" data-tab="style" onmousedown="evtPd(event)">Style</button>
    <button class="tab-btn" data-tab="format" onmousedown="evtPd(event)">Format</button>
    <button class="tab-btn" data-tab="paper" onmousedown="evtPd(event)">Paper</button>
    <button class="tab-btn" data-tab="meta" onmousedown="evtPd(event)">Meta</button>
  </div>

  <div class="panel-content" id="panelContent"></div>
</div>

<script>
  // --- HELPERS ---
  const $ = id => document.getElementById(id);
  const evtPd = e => e.preventDefault();
  
  // --- STATE ---
  const NOTES_KEY = 'zeli_garden_v4';
  let notes = JSON.parse(localStorage.getItem(NOTES_KEY) || '[]');
  let currentNote = null;
  let isNewNote = false;
  let isArrangeMode = false;
  let selectedSticker = null;
  let savedRange = null; // Cursor memory
  let emojiPicker = null; // Picmo instance

  // --- ELEMENTS ---
  const elements = {
    list: $('notesList'), editorView: $('editorView'), 
    editor: $('richEditor'), title: $('noteTitle'),
    paper: $('paperContainer'), pattern: $('paperPattern'),
    layerBack: $('stickerLayerBack'), layerFront: $('stickerLayerFront'),
    panel: $('megaPanel'), panelContent: $('panelContent'), overlay: $('overlay')
  };

  // --- INIT ---
  window.addEventListener('DOMContentLoaded', () => {
    renderList();
    initListeners();
  });

  function initListeners() {
    $('backBtn').addEventListener('click', closeEditor);
    elements.editor.addEventListener('input', debounce(autoSave, 1000));
    elements.title.addEventListener('input', debounce(autoSave, 1000));
    
    // Save Cursor Position Events
    ['keyup', 'mouseup', 'touchend', 'input', 'blur'].forEach(ev => {
      elements.editor.addEventListener(ev, saveSelection);
    });

    $('closePanel').addEventListener('click', closePanel);
    elements.overlay.addEventListener('click', closePanel);
    $('alignBtn').addEventListener('click', toggleAlign);

    // Panel Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        renderPanel(e.target.dataset.tab);
      });
    });

    // Deselect Logic
    elements.paper.addEventListener('click', (e) => {
      if(e.target === elements.paper || e.target === elements.editor) deselectSticker();
    });
  }

  // --- CORE FUNCTIONS ---
  function renderList() {
    elements.list.innerHTML = '';
    // Add Button
    const addCard = document.createElement('div');
    addCard.className = 'note-card add-btn-card';
    addCard.innerHTML = '<i class="fas fa-plus" style="font-size:30px; margin-bottom:10px;"></i><br>New Story';
    addCard.onclick = createNote;
    elements.list.appendChild(addCard);

    notes.forEach(note => {
      const card = document.createElement('div');
      card.className = 'note-card';
      const prevDiv = document.createElement('div');
      prevDiv.innerHTML = note.content;
      const preview = prevDiv.textContent.substring(0, 120) || 'Kosong...';
      
      card.innerHTML = `
        <h3>${note.title || 'Tanpa Judul'}</h3>
        <div class="preview">${preview}</div>
        <div class="meta">
          <span>${new Date(note.updatedAt).toLocaleDateString()}</span>
          <span>${note.mood || 'ðŸŒ¿'}</span>
        </div>
        <button class="delete-card-btn" onclick="deleteNote('${note.id}', event)"><i class="fas fa-times"></i></button>
      `;
      card.onclick = (e) => { if(!e.target.closest('.delete-card-btn')) openNote(note.id); };
      elements.list.appendChild(card);
    });
  }

  function createNote() {
    isNewNote = true;
    currentNote = {
      id: Date.now().toString(), title: '', content: '', stickers: [],
      theme: 'default', paper: 'lines', mood: 'ðŸŒ¿', updatedAt: Date.now()
    };
    loadNoteData();
    isArrangeMode = true; toggleEditMode(); // Set to write mode
    elements.editorView.classList.add('active');
    setTimeout(() => { elements.editor.focus(); saveSelection(); }, 100);
  }

  function openNote(id) {
    isNewNote = false;
    currentNote = notes.find(n => n.id === id);
    if(!currentNote) return;
    loadNoteData();
    isArrangeMode = true; toggleEditMode();
    elements.editorView.classList.add('active');
  }

  function loadNoteData() {
    elements.title.value = currentNote.title;
    elements.editor.innerHTML = currentNote.content;
    applyTheme(currentNote.theme, false);
    applyPaper(currentNote.paper);
    
    elements.layerBack.innerHTML = '';
    elements.layerFront.innerHTML = '';
    (currentNote.stickers || []).forEach(renderSticker);
    savedRange = null;
  }

  function autoSave() {
    // Auto Title Logic: If empty, take first 4 words
    if(!elements.title.value.trim() && elements.editor.innerText.trim()) {
      const words = elements.editor.innerText.trim().split(/\s+/).slice(0, 4).join(' ');
      currentNote.title = words;
      // Note: We don't update the Input value to keep it clean, but we save it.
      // If you want to show it: elements.title.value = words; 
    } else {
      currentNote.title = elements.title.value;
    }

    currentNote.content = elements.editor.innerHTML;
    currentNote.stickers = getStickersData();
    currentNote.updatedAt = Date.now();

    const idx = notes.findIndex(n => n.id === currentNote.id);
    if(idx > -1) notes[idx] = currentNote;
    else { notes.unshift(currentNote); isNewNote = false; }
    
    localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
    $('saveIndicator').innerText = 'Disimpan...';
    setTimeout(() => $('saveIndicator').innerText = '', 2000);
  }

  function closeEditor() {
    if(!elements.title.value.trim() && !elements.editor.textContent.trim() && currentNote.stickers.length === 0) {
       notes = notes.filter(n => n.id !== currentNote.id);
       localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
    } else {
      autoSave();
    }
    elements.editorView.classList.remove('active');
    renderList();
  }

  function deleteNote(id, e) {
    e.stopPropagation();
    if(confirm('Hapus catatan?')) {
      notes = notes.filter(n => n.id !== id);
      localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
      renderList();
    }
  }

  // --- EDITOR UTILS ---
  function saveSelection() {
    if(isArrangeMode) return;
    const sel = window.getSelection();
    if(sel.rangeCount > 0) {
      const range = sel.getRangeAt(0);
      if(elements.editor.contains(range.commonAncestorContainer)) savedRange = range;
    }
  }

  function restoreSelection() {
    elements.editor.focus();
    if(savedRange) {
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(savedRange);
    } else {
      // Place cursor at end if lost
      const range = document.createRange();
      range.selectNodeContents(elements.editor);
      range.collapse(false);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    }
  }

  function execCmd(cmd, val=null) {
    restoreSelection(); document.execCommand(cmd, false, val); saveSelection(); autoSave();
  }

  function toggleEditMode() {
    isArrangeMode = !isArrangeMode;
    const btn = $('modeBtn');
    if(isArrangeMode) {
      elements.paper.classList.add('arrange-mode');
      elements.editor.contentEditable = false;
      btn.innerHTML = '<i class="fas fa-hand-pointer"></i>';
      btn.classList.remove('active');
    } else {
      elements.paper.classList.remove('arrange-mode');
      elements.editor.contentEditable = true;
      btn.innerHTML = '<i class="fas fa-pen"></i>';
      btn.classList.add('active');
      restoreSelection();
    }
  }

  function toggleAlign() {
    restoreSelection();
    const modes = ['justifyLeft', 'justifyCenter', 'justifyRight'];
    const icons = ['fa-align-left', 'fa-align-center', 'fa-align-right'];
    let idx = parseInt($('alignBtn').dataset.idx || 0);
    idx = (idx + 1) % 3;
    document.execCommand(modes[idx]);
    $('alignBtn').dataset.idx = idx;
    $('alignBtn').innerHTML = `<i class="fas ${icons[idx]}"></i>`;
    saveSelection();
  }

  function insertCheckbox() {
    restoreSelection();
    document.execCommand('insertHTML', false, '<input type="checkbox" style="vertical-align:middle; margin-right:5px;">&nbsp;');
    saveSelection();
  }

  function insertImagePrompt() {
    const input = document.createElement('input'); input.type='file'; input.accept='image/*';
    input.onchange = e => {
      const f = e.target.files[0];
      if(f) {
        const r = new FileReader();
        r.onload = ev => { restoreSelection(); document.execCommand('insertImage', false, ev.target.result); saveSelection(); };
        r.readAsDataURL(f);
      }
    };
    input.click();
  }

  // --- STICKER ENGINE (Advanced Gestures) ---
  function addSticker(emoji) {
    const s = { id: 's'+Date.now(), emoji, x: 100, y: 100, rot: 0, scale: 1.5, layer: 'front' };
    renderSticker(s);
    autoSave();
    // Keep panel open for more stickers
  }

  function renderSticker(data) {
    const el = document.createElement('div');
    el.className = 'sticker'; el.id = data.id;
    el.style.left = data.x + 'px'; el.style.top = data.y + 'px';
    el.style.transform = `rotate(${data.rot}deg) scale(${data.scale})`;
    el.dataset.emoji = data.emoji; el.dataset.rot = data.rot; 
    el.dataset.scale = data.scale; el.dataset.layer = data.layer;
    
    el.innerHTML = `
      <div class="sticker-content">${data.emoji}</div>
      <div class="sticker-controls">
        <div class="ctrl-btn ctrl-del"><i class="fas fa-times"></i></div>
        <div class="ctrl-btn ctrl-layer"><i class="fas fa-layer-group"></i></div>
      </div>
    `; // Removed rotate/resize handles for mobile cleanness, gestures used instead

    const parent = data.layer === 'back' ? elements.layerBack : elements.layerFront;
    parent.appendChild(el);
    attachStickerEvents(el);
  }

  function attachStickerEvents(el) {
    // Mouse & Touch Logic
    let startX, startY, startRot, startScale;
    let initialPinchDist = 0;
    let initialPinchAngle = 0;

    const onStart = (e) => {
      if(e.target.classList.contains('ctrl-btn')) return;
      selectSticker(el);
      
      if(e.type === 'touchstart' && e.touches.length === 2) {
        // Pinch / Rotate Mode
        e.preventDefault();
        const t1 = e.touches[0]; const t2 = e.touches[1];
        initialPinchDist = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
        initialPinchAngle = Math.atan2(t2.clientY - t1.clientY, t2.clientX - t1.clientX);
        startScale = parseFloat(el.dataset.scale);
        startRot = parseFloat(el.dataset.rot);
      } else {
        // Drag Mode
        const p = e.type.includes('mouse') ? e : e.touches[0];
        startX = p.clientX; startY = p.clientY;
        el.dataset.startX = el.offsetLeft;
        el.dataset.startY = el.offsetTop;
      }
      
      document.addEventListener(e.type === 'mousedown' ? 'mousemove' : 'touchmove', onMove, {passive:false});
      document.addEventListener(e.type === 'mousedown' ? 'mouseup' : 'touchend', onEnd);
    };

    const onMove = (e) => {
      if(e.type === 'touchmove' && e.touches.length === 2) {
        // Handle Pinch/Rotate
        e.preventDefault();
        const t1 = e.touches[0]; const t2 = e.touches[1];
        const dist = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
        const angle = Math.atan2(t2.clientY - t1.clientY, t2.clientX - t1.clientX);
        
        // Scale
        const scaleDiff = (dist / initialPinchDist);
        const newScale = Math.max(0.5, Math.min(5, startScale * scaleDiff));
        
        // Rotate (convert radians to deg)
        const angleDiff = (angle - initialPinchAngle) * (180/Math.PI);
        const newRot = startRot + angleDiff;

        el.style.transform = `rotate(${newRot}deg) scale(${newScale})`;
        el.dataset.scale = newScale;
        el.dataset.rot = newRot;

      } else if ((e.type === 'mousemove' || e.touches.length === 1)) {
        // Handle Drag
        e.preventDefault(); // Stop page scroll
        const p = e.type.includes('mouse') ? e : e.touches[0];
        const dx = p.clientX - startX;
        const dy = p.clientY - startY;
        el.style.left = (parseFloat(el.dataset.startX) + dx) + 'px';
        el.style.top = (parseFloat(el.dataset.startY) + dy) + 'px';
      }
    };

    const onEnd = () => {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('touchmove', onMove);
      document.removeEventListener('mouseup', onEnd);
      document.removeEventListener('touchend', onEnd);
      autoSave();
    };

    el.addEventListener('mousedown', onStart);
    el.addEventListener('touchstart', onStart, {passive:false});

    // Button Events
    el.querySelector('.ctrl-del').addEventListener('click', (e) => { e.stopPropagation(); el.remove(); autoSave(); });
    el.querySelector('.ctrl-layer').addEventListener('click', (e) => {
      e.stopPropagation();
      const isFront = el.dataset.layer === 'front';
      el.dataset.layer = isFront ? 'back' : 'front';
      if(isFront) elements.layerBack.appendChild(el); else elements.layerFront.appendChild(el);
      autoSave();
    });
  }

  function selectSticker(el) {
    if(selectedSticker) selectedSticker.classList.remove('selected');
    selectedSticker = el; el.classList.add('selected');
  }
  function deselectSticker() {
    if(selectedSticker) { selectedSticker.classList.remove('selected'); selectedSticker = null; }
  }

  function getStickersData() {
    const arr = [];
    [elements.layerBack, elements.layerFront].forEach(layer => {
      Array.from(layer.children).forEach(el => {
        arr.push({ 
          id: el.id, emoji: el.dataset.emoji, 
          x: parseFloat(el.style.left), y: parseFloat(el.style.top), 
          rot: parseFloat(el.dataset.rot), scale: parseFloat(el.dataset.scale), 
          layer: el.dataset.layer 
        });
      });
    });
    return arr;
  }

  // --- PANELS & THEMES ---
  function openPanel(tab) {
    saveSelection();
    elements.panel.classList.add('open'); elements.overlay.classList.add('active');
    document.querySelector(`.tab-btn[data-tab="${tab}"]`).click();
  }
  function closePanel() {
    elements.panel.classList.remove('open'); elements.overlay.classList.remove('active');
    if(!isArrangeMode) restoreSelection();
  }

  function renderPanel(tab) {
    elements.panelContent.innerHTML = '';

    if(tab === 'stickers') {
      // Initialize Picmo
      const container = document.createElement('div');
      container.id = 'emojiContainer';
      elements.panelContent.appendChild(container);
      
      if(!emojiPicker) {
        emojiPicker = picmo.createPicker({ rootElement: container, native: true });
        emojiPicker.addEventListener('emoji:select', selection => {
          addSticker(selection.emoji);
        });
      } else {
        // Re-append existing instance logic if needed, but creating new is safer for layout
        container.innerHTML = ''; 
        emojiPicker = picmo.createPicker({ rootElement: container, native: true });
        emojiPicker.addEventListener('emoji:select', selection => addSticker(selection.emoji));
      }
    } 
    else if(tab === 'style') {
      // Font & Style
      const fonts = ['Quicksand', 'Caveat', 'Kalam', 'Sacramento', 'Dancing Script', 'Indie Flower', 'Courier New'];
      let h = `<div class="tool-grid">`;
      fonts.forEach(f => {
        h += `<div class="tool-item" onmousedown="evtPd(event)" onclick="setFont('${f}')" style="font-family:${f}; font-size:16px;">Aa<br><span>${f}</span></div>`;
      });
      h += `</div><hr style="border:0; border-top:1px solid #eee; margin:15px 0;">`;
      h += `<div class="tool-grid">
         <div class="tool-item" onmousedown="evtPd(event)" onclick="execCmd('fontSize', 3)">Norm</div>
         <div class="tool-item" onmousedown="evtPd(event)" onclick="execCmd('fontSize', 5)">Big</div>
         <div class="tool-item" onmousedown="evtPd(event)" onclick="execCmd('hiliteColor', '#ffd6e0')"><span style="background:#ffd6e0">Hilite</span></div>
      </div>`;
      elements.panelContent.innerHTML = h;
    }
    else if(tab === 'theme') {
      const themes = [
        {id:'default', name:'ðŸŒ¿ Soft', col:'#3f6f45', bg:'#fffaf0'},
        {id:'dark', name:'ðŸŒ‘ Night', col:'#ddd', bg:'#222'},
        {id:'pink', name:'ðŸŒ¸ Pink', col:'#c56582', bg:'#fff0f5'},
        {id:'blue', name:'ðŸ¦‹ Sky', col:'#333', bg:'#f0f8ff'}
      ];
      let h = '<div class="theme-grid">';
      themes.forEach(t => {
        h += `<div class="theme-card" onmousedown="evtPd(event)" style="background:${t.col}" onclick="applyTheme('${t.id}')">
          <span>${t.name}</span><div style="width:15px;height:15px;border-radius:50%;background:${t.bg}"></div>
        </div>`;
      });
      h += '</div>';
      elements.panelContent.innerHTML = h;
    }
    else if(tab === 'format') {
       elements.panelContent.innerHTML = `
        <div class="tool-grid">
          <div class="tool-item" onmousedown="evtPd(event)" onclick="execCmd('insertUnorderedList')"><i class="fas fa-list-ul"></i><span>List</span></div>
          <div class="tool-item" onmousedown="evtPd(event)" onclick="execCmd('insertOrderedList')"><i class="fas fa-list-ol"></i><span>123</span></div>
          <div class="tool-item" onmousedown="evtPd(event)" onclick="execCmd('insertHorizontalRule')"><i class="fas fa-minus"></i><span>Line</span></div>
          <div class="tool-item" onmousedown="evtPd(event)" onclick="document.execCommand('insertHTML',false,'<blockquote>Quote</blockquote>')"><i class="fas fa-quote-right"></i><span>Quote</span></div>
        </div>`;
    }
    else if(tab === 'paper') {
       elements.panelContent.innerHTML = `
        <div class="tool-grid">
          <div class="tool-item" onmousedown="evtPd(event)" onclick="applyPaper('lines')"><i class="fas fa-bars"></i><span>Garis</span></div>
          <div class="tool-item" onmousedown="evtPd(event)" onclick="applyPaper('grid')"><i class="fas fa-border-all"></i><span>Kotak</span></div>
          <div class="tool-item" onmousedown="evtPd(event)" onclick="applyPaper('plain')"><i class="far fa-file"></i><span>Polos</span></div>
        </div>`;
    }
    else if(tab === 'meta') {
       elements.panelContent.innerHTML = `
        <div class="tool-grid">
           <div class="tool-item" onmousedown="evtPd(event)" onclick="alert(elements.editor.innerText.split(' ').length + ' Words')"><i class="fas fa-calculator"></i><span>Count</span></div>
           <div class="tool-item" onmousedown="evtPd(event)" onclick="const m=prompt('Mood?'); if(m){currentNote.mood=m; autoSave();}"><i class="far fa-smile"></i><span>Mood</span></div>
        </div>`;
    }
  }

  function setFont(f) { execCmd('fontName', f); }
  
  function applyTheme(id, save=true) {
    if(save) { currentNote.theme = id; autoSave(); }
    const t = {
      'default': { bg:'#fffaf0', col:'#333', font:'Quicksand'},
      'dark': { bg:'#2d2d2d', col:'#e0e0e0', font:'Inter'},
      'pink': { bg:'#fff0f5', col:'#880e4f', font:'Caveat'},
      'blue': { bg:'#f0f8ff', col:'#01579b', font:'Nunito'}
    }[id] || {bg:'#fffaf0'};
    
    elements.paper.style.backgroundColor = t.bg;
    elements.editor.style.color = t.col;
    if(save) elements.editor.style.fontFamily = t.font;
  }

  function applyPaper(type) {
    currentNote.paper = type;
    const c = currentNote.theme === 'dark' ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';
    let bg = '';
    if(type === 'lines') bg = `repeating-linear-gradient(transparent, transparent 31px, ${c} 31px, ${c} 32px)`;
    if(type === 'grid') bg = `linear-gradient(${c} 1px, transparent 1px), linear-gradient(90deg, ${c} 1px, transparent 1px)`;
    elements.pattern.style.backgroundImage = bg;
    elements.pattern.style.backgroundSize = type === 'grid' ? '20px 20px' : '100% 32px';
    autoSave();
  }

  function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(()=>fn(...a), ms); }}
</script>
</body>
</html>
