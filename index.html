<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Garden Notepad ‚Äî Zeli's Garden</title>
  
  <!-- Fonts Google -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;600&family=Poppins:wght@300;400&family=Nunito:wght@400;700&family=Baloo+2&family=Comic+Neue&family=Inter:wght@300;400&family=Caveat:wght@400;700&family=Kalam&family=Gloria+Hallelujah&family=Reenie+Beanie&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --sky-1: #e6f9ff;
      --sky-2: #cfeefd;
      --green-1: #f0fbf2;
      --green-2: #dff9e6;
      --green-3: #8ecf9a;
      --accent: #ffd6e0;
      --card: rgba(255,255,255,0.95);
      --muted: #6b6b6b;
      --shadow: 0 8px 20px rgba(51,51,51,0.08);
      
      /* Default Note Theme */
      --paper-bg: #fffaf0;
      --paper-line: rgba(0,0,0,0.05);
      --font-main: 'Quicksand', sans-serif;
      --text-color: #333;
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%;margin:0;font-family:'Quicksand',sans-serif;}

    body{
      background: linear-gradient(180deg,var(--sky-1),var(--sky-2) 40%,var(--green-1) 60%,var(--green-2));
      background-attachment: fixed;
      display:flex;align-items:center;justify-content:center;
    }

    .app {
      width:100vw; height:100vh; position:relative; overflow:hidden;
      background: rgba(255,255,255,0.5);
      backdrop-filter: blur(5px);
      display: flex; flex-direction: column;
    }

    /* --- HEADER --- */
    .header{
      flex: 0 0 auto; height:90px; padding:0 20px; display:flex; align-items:center; gap:15px;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.0));
      z-index: 10;
    }
    .logo{
      width:50px; height:50px; border-radius:12px; 
      background: linear-gradient(135deg, var(--green-3), var(--green-2));
      display:flex; align-items:center; justify-content:center; 
      font-size:24px; color:#fff; box-shadow:0 4px 10px rgba(0,0,0,0.1);
    }
    .title h1{ margin:0; font-size:18px; color:#333; }
    .title p{ margin:0; color:var(--muted); font-size:12px; }

    /* --- NOTES LIST --- */
    .notes-list-view {
      flex: 1; overflow-y: auto; padding: 20px;
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;
    }
    .note-card {
      background: var(--card); border-radius: 16px; padding: 18px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer;
      display: flex; flex-direction: column; height: 160px;
      transition: all 0.2s; border: 1px solid rgba(255,255,255,0.5);
      position: relative;
    }
    .note-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
    .note-card h3 { margin: 0 0 8px; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .note-card .preview { font-size: 13px; color: #666; flex: 1; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; }
    .note-card .meta { font-size: 11px; color: #999; margin-top: 10px; display: flex; justify-content: space-between; }
    
    .add-btn-card {
      border: 2px dashed var(--green-3); background: rgba(255,255,255,0.5);
      color: var(--green-3); align-items: center; justify-content: center;
    }
    .delete-card-btn {
      position: absolute; top: 10px; right: 10px; border: none; background: #fff;
      width: 24px; height: 24px; border-radius: 50%; color: #ff8888; cursor: pointer;
      display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      opacity: 0; transition: 0.2s;
    }
    .note-card:hover .delete-card-btn { opacity: 1; }

    /* --- EDITOR VIEW --- */
    .editor-view {
      position: fixed; inset: 0; background: #f4f9f4;
      display: flex; flex-direction: column;
      transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 50;
    }
    .editor-view.active { transform: translateX(0); }

    .editor-topbar {
      height: 60px; padding: 0 15px; display: flex; align-items: center; gap: 10px;
      background: white; border-bottom: 1px solid #eee;
    }
    .back-btn { border: none; background: transparent; font-size: 18px; padding: 10px; cursor: pointer; color: #555; }
    
    .note-title-input {
      flex: 1; border: none; font-size: 18px; font-weight: 600; outline: none;
      font-family: 'Quicksand', sans-serif; color: #333;
    }

    .editor-workspace {
      flex: 1; position: relative; overflow: hidden; display: flex;
      justify-content: center; padding: 20px; background: #eef5ee;
    }

    /* Paper Container */
    .paper-container {
      width: 100%; max-width: 800px; height: 100%;
      position: relative;
      background: var(--paper-bg);
      box-shadow: 0 5px 25px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden; /* Contains stickers */
    }

    /* 
       LAYERING SYSTEM:
       1. Paper Background (Lines/Grid) - Absolute Bottom
       2. Back Stickers - Z-Index 1
       3. Text Editor - Z-Index 5 (Transparent BG)
       4. Front Stickers - Z-Index 10
    */

    .paper-pattern {
      position: absolute; inset: 0; pointer-events: none; z-index: 0;
      /* Default lines */
      background-image: repeating-linear-gradient(transparent, transparent 31px, var(--paper-line) 31px, var(--paper-line) 32px);
      background-size: 100% 32px;
      margin-top: 20px; /* Offset for padding */
    }

    .sticker-layer {
      position: absolute; inset: 0; overflow: hidden; pointer-events: none;
    }
    .sticker-layer.front { z-index: 10; }
    .sticker-layer.back { z-index: 1; }

    /* Rich Editor Styling */
    .rich-editor {
      position: relative; width: 100%; height: 100%;
      border: none; outline: none; padding: 25px 30px;
      font-size: 16px; line-height: 2;
      font-family: var(--font-main);
      color: var(--text-color);
      background: transparent; /* Crucial for back stickers */
      overflow-y: auto;
      z-index: 5;
    }
    
    /* Styling for rich text inside editor */
    .rich-editor img { max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .rich-editor blockquote { 
      border-left: 4px solid var(--green-3); margin: 10px 0; padding-left: 10px; color: #666; font-style: italic; background: rgba(0,0,0,0.02);
    }
    .rich-editor ul, .rich-editor ol { padding-left: 20px; }
    .highlight-pastel { background: linear-gradient(120deg, #ffd6e0 0%, #ffd6e0 100%); border-radius: 4px; padding: 0 4px; }

    /* --- STICKERS --- */
    .sticker {
      position: absolute; display: inline-flex; align-items: center; justify-content: center;
      cursor: grab; user-select: none; touch-action: none; pointer-events: auto;
      transform-origin: center;
    }
    .sticker:active { cursor: grabbing; }
    .sticker-content { font-size: 40px; line-height: 1; pointer-events: none; }
    
    .sticker-controls {
      position: absolute; inset: -15px; border: 2px dashed #8ecf9a; border-radius: 8px;
      display: none; pointer-events: none;
    }
    .sticker.selected .sticker-controls { display: block; }
    
    /* Control Handles */
    .ctrl-btn {
      position: absolute; width: 28px; height: 28px; background: white; border: 1px solid #ddd;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 12px; color: #555; pointer-events: auto; cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100;
    }
    .ctrl-btn:hover { background: var(--sky-1); }
    
    .ctrl-del { top: -14px; right: -14px; color: #ff6b6b; }
    .ctrl-resize { bottom: -14px; right: -14px; cursor: se-resize; color: #444; }
    .ctrl-rot { top: -35px; left: 50%; transform: translateX(-50%); cursor: grab; }
    .ctrl-layer { bottom: -14px; left: -14px; color: #4D89FF; font-weight: bold; }

    /* --- MEGA MENU TOOLBAR --- */
    .floating-menu-btn {
      position: absolute; bottom: 25px; right: 25px;
      width: 60px; height: 60px; border-radius: 50%;
      background: var(--green-3); color: white;
      border: none; box-shadow: 0 5px 15px rgba(142, 207, 154, 0.5);
      font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;
      z-index: 100; transition: transform 0.2s;
    }
    .floating-menu-btn:active { transform: scale(0.9); }

    /* BASIC FORMATTING BAR (Visible) */
    .mini-toolbar {
      position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
      background: rgba(255,255,255,0.95); padding: 8px 20px; border-radius: 50px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1); backdrop-filter: blur(5px);
      display: flex; gap: 20px; z-index: 100;
    }
    .mini-btn { border: none; background: none; font-size: 18px; color: #555; cursor: pointer; padding: 5px; }
    .mini-btn:hover { color: var(--green-3); }
    .mini-btn.active { color: var(--green-3); }

    /* SLIDE UP PANEL */
    .mega-panel {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 65vh;
      background: white; border-radius: 25px 25px 0 0;
      box-shadow: 0 -5px 30px rgba(0,0,0,0.15);
      z-index: 200; transform: translateY(110%);
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .mega-panel.open { transform: translateY(0); }

    .panel-header {
      padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
    }
    .panel-header h3 { margin:0; font-size:16px; }
    .panel-tabs {
      display: flex; gap: 10px; overflow-x: auto; padding: 10px 15px;
      background: #fcfcfc; border-bottom: 1px solid #eee; scrollbar-width: none;
    }
    .tab-btn {
      padding: 8px 16px; border-radius: 20px; border: 1px solid #eee; background: white;
      font-size: 13px; cursor: pointer; white-space: nowrap; color: #555;
    }
    .tab-btn.active { background: var(--green-2); border-color: var(--green-3); color: #2d5a35; font-weight: 600; }

    .panel-content { flex: 1; overflow-y: auto; padding: 20px; }
    .tool-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 12px; }
    .tool-item {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 12px; background: #f9f9f9; border-radius: 12px; cursor: pointer; text-align: center; gap: 8px;
      border: 1px solid transparent;
    }
    .tool-item:hover { background: #f0fbf2; border-color: var(--green-3); }
    .tool-item i { font-size: 20px; color: #666; }
    .tool-item span { font-size: 11px; color: #333; }

    /* Font List Style */
    .font-option { padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display:flex; justify-content:space-between; }
    .font-option:hover { background: #f9f9f9; }
    
    /* Preset Themes */
    .theme-card {
      padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; color: white;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    /* Sticker Grid in Panel */
    .sticker-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; font-size: 28px; }
    .sticker-item { text-align: center; cursor: pointer; padding: 5px; border-radius: 8px; transition: transform 0.1s; }
    .sticker-item:hover { background: #eee; transform: scale(1.1); }

    /* Overlay */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 150;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .overlay.active { opacity: 1; pointer-events: auto; }

    @media(max-width: 600px) {
      .mini-toolbar { width: 90%; justify-content: space-around; }
      .sticker-grid { grid-template-columns: repeat(5, 1fr); }
    }
  </style>
</head>
<body>

<div class="app">
  <!-- Main List Screen -->
  <div class="header">
    <div class="logo">üåø</div>
    <div class="title">
      <h1>Garden Notepad</h1>
      <p>Catatan estetika & stiker</p>
    </div>
  </div>

  <div class="notes-list-view" id="notesList">
    <!-- Notes will be injected here -->
  </div>
  
  <div class="footer">
    <div>Garden Notepad v3</div>
    <div id="status">Ready</div>
  </div>
</div>

<!-- Editor Screen (Full Page Slide) -->
<div class="editor-view" id="editorView">
  <div class="editor-topbar">
    <button class="back-btn" id="backBtn"><i class="fas fa-arrow-left"></i></button>
    <input type="text" class="note-title-input" id="noteTitle" placeholder="Judul Catatan..." />
    <div id="saveIndicator" style="font-size:12px; color:var(--green-3); font-weight:600;"></div>
  </div>

  <div class="editor-workspace">
    <div class="paper-container" id="paperContainer">
      <!-- Background Pattern -->
      <div class="paper-pattern" id="paperPattern"></div>
      
      <!-- Layer 1: Stickers BEHIND text (estetika background) -->
      <div class="sticker-layer back" id="stickerLayerBack"></div>
      
      <!-- Layer 2: Text Editor -->
      <div class="rich-editor" id="richEditor" contenteditable="true" spellcheck="false" placeholder="Tulis ceritamu di sini..."></div>
      
      <!-- Layer 3: Stickers FRONT of text -->
      <div class="sticker-layer front" id="stickerLayerFront"></div>
    </div>
  </div>

  <!-- Mini Toolbar (Quick Actions) -->
  <div class="mini-toolbar">
    <button class="mini-btn" onclick="execCmd('bold')" title="Bold"><i class="fas fa-bold"></i></button>
    <button class="mini-btn" onclick="execCmd('italic')" title="Italic"><i class="fas fa-italic"></i></button>
    <button class="mini-btn" onclick="execCmd('underline')" title="Underline"><i class="fas fa-underline"></i></button>
    <button class="mini-btn" id="alignBtn" title="Alignment"><i class="fas fa-align-left"></i></button>
    <button class="mini-btn" onclick="openPanel('stickers')" title="Quick Sticker"><i class="fas fa-smile"></i></button>
  </div>

  <!-- Mega Menu Button -->
  <button class="floating-menu-btn" id="menuBtn">
    <i class="fas fa-plus"></i>
  </button>
</div>

<!-- Overlay for Mega Panel -->
<div class="overlay" id="overlay"></div>

<!-- Mega Panel (Slide Up) -->
<div class="mega-panel" id="megaPanel">
  <div class="panel-header">
    <h3>Tools & Decor</h3>
    <button id="closePanel" style="border:none;background:none;font-size:20px;">&times;</button>
  </div>
  
  <div class="panel-tabs">
    <button class="tab-btn active" data-tab="insert">Insert</button>
    <button class="tab-btn" data-tab="style">Style</button>
    <button class="tab-btn" data-tab="layout">Layout</button>
    <button class="tab-btn" data-tab="theme">Theme</button>
    <button class="tab-btn" data-tab="stickers">Stickers</button>
    <button class="tab-btn" data-tab="tools">Tools</button>
  </div>

  <div class="panel-content" id="panelContent">
    <!-- Dynamic Content Loaded via JS -->
  </div>
</div>

<script>
  // --- STATE MANAGEMENT ---
  const NOTES_KEY = 'garden_notes_v3';
  let notes = JSON.parse(localStorage.getItem(NOTES_KEY) || '[]');
  let currentNote = null;
  let isNewNote = false;
  let selectedSticker = null;

  // --- DOM ELEMENTS ---
  const $ = id => document.getElementById(id);
  const notesListEl = $('notesList');
  const editorView = $('editorView');
  const richEditor = $('richEditor');
  const noteTitle = $('noteTitle');
  const paperContainer = $('paperContainer');
  const paperPattern = $('paperPattern');
  const stickerLayerBack = $('stickerLayerBack');
  const stickerLayerFront = $('stickerLayerFront');
  const megaPanel = $('megaPanel');
  const overlay = $('overlay');
  const panelContent = $('panelContent');

  // --- INITIALIZATION ---
  window.addEventListener('DOMContentLoaded', () => {
    renderNotesList();
    setupListeners();
  });

  function setupListeners() {
    // Navigation
    $('backBtn').addEventListener('click', closeEditor);
    
    // Auto-save logic
    richEditor.addEventListener('input', debounce(autoSave, 1000));
    noteTitle.addEventListener('input', debounce(autoSave, 1000));

    // Panel Logic
    $('menuBtn').addEventListener('click', () => openPanel('insert'));
    $('closePanel').addEventListener('click', closePanel);
    $('overlay').addEventListener('click', closePanel);

    // Alignment Toggle
    $('alignBtn').addEventListener('click', toggleAlign);

    // Tab Switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        renderTabContent(e.target.dataset.tab);
      });
    });

    // Deselect stickers on BG click (if clicking editor empty space)
    richEditor.addEventListener('mousedown', (e) => {
      if(e.target === richEditor) deselectSticker();
    });
    
    // Click pass-through for back stickers is handled by sticker interaction
  }

  // --- NOTE CRUD ---
  function renderNotesList() {
    notesListEl.innerHTML = '';
    
    // Add Button
    const addBtn = document.createElement('div');
    addBtn.className = 'note-card add-btn-card';
    addBtn.innerHTML = '<i class="fas fa-plus-circle" style="font-size:32px;margin-bottom:10px;"></i><span>Buat Catatan Baru</span>';
    addBtn.onclick = createNewNote;
    notesListEl.appendChild(addBtn);

    // Note Items
    notes.forEach(note => {
      const card = document.createElement('div');
      card.className = 'note-card';
      
      // Get preview text from HTML content (strip tags)
      const div = document.createElement('div');
      div.innerHTML = note.content;
      const textPreview = div.textContent.substring(0, 100) || 'Tidak ada teks...';

      card.innerHTML = `
        <h3>${note.title || 'Untitled'}</h3>
        <div class="preview">${textPreview}</div>
        <div class="meta">
          <span>${new Date(note.updatedAt).toLocaleDateString()}</span>
          <span>${note.mood || 'üìù'}</span>
        </div>
        <button class="delete-card-btn" onclick="deleteNote('${note.id}', event)"><i class="fas fa-trash"></i></button>
      `;
      card.onclick = (e) => {
        if(!e.target.closest('.delete-card-btn')) openNote(note.id);
      };
      notesListEl.appendChild(card);
    });
  }

  function createNewNote() {
    isNewNote = true;
    currentNote = {
      id: Date.now().toString(),
      title: '',
      content: '',
      stickers: [],
      theme: 'default',
      paperType: 'lines',
      mood: 'üåø',
      createdAt: Date.now(),
      updatedAt: Date.now()
    };
    
    // Reset Editor UI
    noteTitle.value = '';
    richEditor.innerHTML = '';
    stickerLayerBack.innerHTML = '';
    stickerLayerFront.innerHTML = '';
    setTheme('default');
    setPaper('lines');
    
    // Show Editor
    editorView.classList.add('active');
  }

  function openNote(id) {
    isNewNote = false;
    currentNote = notes.find(n => n.id === id);
    if(!currentNote) return;

    // Load Data
    noteTitle.value = currentNote.title;
    richEditor.innerHTML = currentNote.content;
    
    // Load Theme & Paper
    setTheme(currentNote.theme || 'default');
    setPaper(currentNote.paperType || 'lines');

    // Load Stickers
    stickerLayerBack.innerHTML = '';
    stickerLayerFront.innerHTML = '';
    (currentNote.stickers || []).forEach(s => renderSticker(s));

    editorView.classList.add('active');
  }

  function autoSave() {
    const isEmpty = !noteTitle.value.trim() && !richEditor.textContent.trim() && document.querySelectorAll('.sticker').length === 0;
    
    if (isEmpty && isNewNote) return; // Jangan simpan jika baru dan kosong

    // Update object
    currentNote.title = noteTitle.value;
    currentNote.content = richEditor.innerHTML;
    currentNote.updatedAt = Date.now();
    currentNote.stickers = getStickersData();
    
    // Update Array
    const idx = notes.findIndex(n => n.id === currentNote.id);
    if (idx > -1) {
      notes[idx] = currentNote;
    } else {
      notes.unshift(currentNote);
      isNewNote = false;
    }
    
    localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
    $('saveIndicator').innerHTML = '<i class="fas fa-check"></i> Saved';
    setTimeout(() => $('saveIndicator').innerText = '', 2000);
  }

  function closeEditor() {
    // Cek jika kosong saat keluar
    const isEmpty = !noteTitle.value.trim() && !richEditor.textContent.trim() && document.querySelectorAll('.sticker').length === 0;
    
    if(isEmpty) {
      // Hapus dari array jika ada (bersihkan sampah)
      notes = notes.filter(n => n.id !== currentNote.id);
      localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
    } else {
      autoSave(); // Force save terakhir
    }

    editorView.classList.remove('active');
    renderNotesList(); // Refresh list otomatis
  }

  function deleteNote(id, e) {
    e.stopPropagation();
    if(confirm('Hapus catatan ini?')) {
      notes = notes.filter(n => n.id !== id);
      localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
      renderNotesList();
    }
  }

  // --- STICKER SYSTEM ---
  function addSticker(emoji) {
    const data = {
      id: 's' + Date.now(),
      emoji: emoji,
      x: 50, y: 50,
      rot: 0, scale: 1,
      layer: 'front' // default
    };
    renderSticker(data);
    autoSave();
    closePanel();
  }

  function renderSticker(data) {
    const el = document.createElement('div');
    el.className = 'sticker';
    el.id = data.id;
    el.style.left = data.x + 'px';
    el.style.top = data.y + 'px';
    el.style.transform = `rotate(${data.rot}deg) scale(${data.scale})`;
    
    // Dataset for logic
    el.dataset.emoji = data.emoji;
    el.dataset.rot = data.rot;
    el.dataset.scale = data.scale;
    el.dataset.layer = data.layer;

    // Content & Controls
    el.innerHTML = `
      <div class="sticker-content">${data.emoji}</div>
      <div class="sticker-controls">
        <div class="ctrl-btn ctrl-del" title="Delete"><i class="fas fa-times"></i></div>
        <div class="ctrl-btn ctrl-resize" title="Resize"><i class="fas fa-expand-arrows-alt"></i></div>
        <div class="ctrl-btn ctrl-rot" title="Rotate"><i class="fas fa-sync-alt"></i></div>
        <div class="ctrl-btn ctrl-layer" title="Layer (Front/Back)">
           <i class="fas fa-layer-group"></i>
        </div>
      </div>
    `;

    // Append to correct layer
    const target = data.layer === 'back' ? stickerLayerBack : stickerLayerFront;
    target.appendChild(el);

    setupStickerEvents(el);
  }

  function setupStickerEvents(el) {
    // Interaction
    el.addEventListener('mousedown', (e) => {
      if(e.target.classList.contains('ctrl-btn')) return;
      selectSticker(el);
      initDrag(e, el);
    });
    
    el.addEventListener('touchstart', (e) => {
      if(e.target.classList.contains('ctrl-btn')) return;
      selectSticker(el);
      initDrag(e.touches[0], el);
    }, {passive: false});

    const controls = el.querySelector('.sticker-controls');

    // DELETE
    controls.querySelector('.ctrl-del').addEventListener('click', (e) => {
      e.stopPropagation(); el.remove(); autoSave();
    });

    // LAYER TOGGLE (Front/Back)
    controls.querySelector('.ctrl-layer').addEventListener('click', (e) => {
      e.stopPropagation();
      const isFront = el.dataset.layer === 'front';
      
      // Toggle
      el.dataset.layer = isFront ? 'back' : 'front';
      
      // Pindahkan DOM
      if(isFront) {
        stickerLayerBack.appendChild(el); // Ke belakang
        e.target.style.color = '#ccc'; // Visual indicator
      } else {
        stickerLayerFront.appendChild(el); // Ke depan
        e.target.style.color = '#4D89FF';
      }
      autoSave();
    });

    // ROTATE
    const rotBtn = controls.querySelector('.ctrl-rot');
    rotBtn.addEventListener('mousedown', e => initRotate(e, el));
    rotBtn.addEventListener('touchstart', e => initRotate(e.touches[0], el));

    // RESIZE
    const resBtn = controls.querySelector('.ctrl-resize');
    resBtn.addEventListener('mousedown', e => initResize(e, el));
    resBtn.addEventListener('touchstart', e => initResize(e.touches[0], el));
  }

  function selectSticker(el) {
    if(selectedSticker) selectedSticker.classList.remove('selected');
    selectedSticker = el;
    el.classList.add('selected');
  }

  function deselectSticker() {
    if(selectedSticker) {
      selectedSticker.classList.remove('selected');
      selectedSticker = null;
    }
  }

  // --- DRAG / ROTATE / RESIZE LOGIC ---
  function initDrag(e, el) {
    const startX = e.clientX;
    const startY = e.clientY;
    const rect = el.getBoundingClientRect();
    const parentRect = paperContainer.getBoundingClientRect();
    
    // Hitung posisi relatif terhadap parent
    const startLeft = el.offsetLeft;
    const startTop = el.offsetTop;

    const onMove = (evt) => {
      const cx = evt.clientX || evt.touches?.[0].clientX;
      const cy = evt.clientY || evt.touches?.[0].clientY;
      const dx = cx - startX;
      const dy = cy - startY;
      
      el.style.left = (startLeft + dx) + 'px';
      el.style.top = (startTop + dy) + 'px';
    };

    const onUp = () => {
      cleanup(); autoSave();
    };

    const cleanup = () => {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      document.removeEventListener('touchmove', onMove);
      document.removeEventListener('touchend', onUp);
    }

    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
    document.addEventListener('touchmove', onMove, {passive:false});
    document.addEventListener('touchend', onUp);
  }

  function initRotate(e, el) {
    e.stopPropagation();
    const rect = el.getBoundingClientRect();
    const cx = rect.left + rect.width/2;
    const cy = rect.top + rect.height/2;

    const onMove = (evt) => {
      const x = evt.clientX || evt.touches?.[0].clientX;
      const y = evt.clientY || evt.touches?.[0].clientY;
      const angle = Math.atan2(y - cy, x - cx) * 180 / Math.PI;
      const rot = angle + 90;
      el.dataset.rot = rot;
      el.style.transform = `rotate(${rot}deg) scale(${el.dataset.scale})`;
    };
    
    const onUp = () => {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      document.removeEventListener('touchmove', onMove);
      document.removeEventListener('touchend', onUp);
      autoSave();
    };
    
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
    document.addEventListener('touchmove', onMove, {passive:false});
    document.addEventListener('touchend', onUp);
  }

  function initResize(e, el) {
    e.stopPropagation();
    const startY = e.clientY || e.touches?.[0].clientY;
    const startScale = parseFloat(el.dataset.scale);

    const onMove = (evt) => {
      const cy = evt.clientY || evt.touches?.[0].clientY;
      const dy = cy - startY;
      // Scale sensitivity
      const newScale = Math.max(0.5, Math.min(3, startScale + (dy * 0.01)));
      el.dataset.scale = newScale;
      el.style.transform = `rotate(${el.dataset.rot}deg) scale(${newScale})`;
    };

    const onUp = () => {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      document.removeEventListener('touchmove', onMove);
      document.removeEventListener('touchend', onUp);
      autoSave();
    };

    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
    document.addEventListener('touchmove', onMove, {passive:false});
    document.addEventListener('touchend', onUp);
  }

  function getStickersData() {
    const arr = [];
    [stickerLayerBack, stickerLayerFront].forEach(layer => {
      Array.from(layer.children).forEach(el => {
        arr.push({
          id: el.id, emoji: el.dataset.emoji,
          x: parseFloat(el.style.left), y: parseFloat(el.style.top),
          rot: parseFloat(el.dataset.rot), scale: parseFloat(el.dataset.scale),
          layer: el.dataset.layer
        });
      });
    });
    return arr;
  }

  // --- MEGA PANEL CONTENT RENDERER ---
  function openPanel(tab) {
    megaPanel.classList.add('open');
    overlay.classList.add('active');
    
    // Simulate Click on Tab
    document.querySelector(`.tab-btn[data-tab="${tab}"]`).click();
  }

  function closePanel() {
    megaPanel.classList.remove('open');
    overlay.classList.remove('active');
  }

  function renderTabContent(tab) {
    panelContent.innerHTML = '';
    
    if(tab === 'insert') {
      panelContent.innerHTML = `
        <div class="tool-grid">
          <div class="tool-item" onclick="insertImagePrompt()"><i class="fas fa-image" style="color:#8ecf9a"></i><span>Image</span></div>
          <div class="tool-item" onclick="execCmd('insertHorizontalRule')"><i class="fas fa-minus"></i><span>Line</span></div>
          <div class="tool-item" onclick="execCmd('insertUnorderedList')"><i class="fas fa-list-ul"></i><span>Bullets</span></div>
          <div class="tool-item" onclick="execCmd('insertOrderedList')"><i class="fas fa-list-ol"></i><span>Number</span></div>
          <div class="tool-item" onclick="insertQuote()"><i class="fas fa-quote-right"></i><span>Quote</span></div>
          <div class="tool-item" onclick="insertCheckbox()"><i class="far fa-check-square"></i><span>Task</span></div>
        </div>
      `;
    }
    else if(tab === 'style') {
      // Font List
      const fonts = ['Quicksand', 'Poppins', 'Nunito', 'Baloo 2', 'Comic Neue', 'Inter', 'Caveat', 'Kalam', 'Gloria Hallelujah', 'Reenie Beanie'];
      let fontHtml = `<div style="margin-bottom:10px;font-weight:bold;">Font Family</div><div style="height:120px;overflow-y:auto;border:1px solid #eee;border-radius:8px;margin-bottom:15px;">`;
      fonts.forEach(f => {
        fontHtml += `<div class="font-option" style="font-family:'${f}'" onclick="setFont('${f}')"><span>${f}</span></div>`;
      });
      fontHtml += '</div>';

      // Sizes
      const sizes = `
        <div style="margin-bottom:5px;font-weight:bold;">Size & Decor</div>
        <div class="tool-grid">
          <div class="tool-item" onclick="execCmd('fontSize', 3)"><span>Normal</span></div>
          <div class="tool-item" onclick="execCmd('fontSize', 5)"><span>Medium</span></div>
          <div class="tool-item" onclick="execCmd('fontSize', 7)"><span>Big</span></div>
          <div class="tool-item" onclick="execCmd('strikeThrough')"><s>Strike</s></div>
          <div class="tool-item" onclick="execCmd('hiliteColor', '#ffd6e0')"><span class="highlight-pastel">Highlight</span></div>
        </div>
      `;
      panelContent.innerHTML = fontHtml + sizes;
    }
    else if(tab === 'layout') {
      panelContent.innerHTML = `
        <div class="tool-grid">
          <div class="tool-item" onclick="setPaper('plain')"><i class="far fa-file"></i><span>Polos</span></div>
          <div class="tool-item" onclick="setPaper('lines')"><i class="fas fa-bars"></i><span>Garis</span></div>
          <div class="tool-item" onclick="setPaper('grid')"><i class="fas fa-border-all"></i><span>Kotak</span></div>
          <div class="tool-item" onclick="toggleFullscreen()"><i class="fas fa-expand"></i><span>Full</span></div>
          <div class="tool-item" onclick="execCmd('justifyLeft')"><i class="fas fa-align-left"></i><span>Left</span></div>
          <div class="tool-item" onclick="execCmd('justifyCenter')"><i class="fas fa-align-center"></i><span>Center</span></div>
          <div class="tool-item" onclick="execCmd('justifyRight')"><i class="fas fa-align-right"></i><span>Right</span></div>
          <div class="tool-item" onclick="execCmd('justifyFull')"><i class="fas fa-align-justify"></i><span>Justify</span></div>
        </div>
      `;
    }
    else if(tab === 'theme') {
       const themes = [
         {id:'default', name:'üåø Soft Garden', col:'#3f6f45', bg:'#fffaf0', font:'Quicksand'},
         {id:'sakura', name:'üå∏ Sakura', col:'#c56582', bg:'#fff0f5', font:'Caveat'},
         {id:'sky', name:'ü¶ã Sky', col:'#333', bg:'#f0f8ff', font:'Nunito'},
         {id:'sunshine', name:'üåº Sunshine', col:'#8c6a2c', bg:'#fffbea', font:'Baloo 2'}
       ];
       let html = '';
       themes.forEach(t => {
         html += `<div class="theme-card" style="background:${t.col}" onclick="applyTheme('${t.id}')">
            <span style="font-family:${t.font}">${t.name}</span>
            <div style="width:20px;height:20px;border-radius:50%;background:${t.bg}"></div>
         </div>`;
       });
       panelContent.innerHTML = html;
    }
    else if(tab === 'stickers') {
      const stickers = [
        'üåø', 'üçÉ', 'üå∏', '‚ú®', 'ü¶ã', 'ü™ª', 'ü™¥', 'üåº', 'üå∫', 'üåª', 
        'üå∑', 'üåπ', 'üå±', 'üåæ', 'üå≤', 'üå≥', 'üå¥', 'üåµ', 'üå∂', 'üçÑ',
        'üêù', 'üêû', 'ü¶ó', 'üï∑', 'üï∏', 'üêå', 'ü¶ü', 'ü¶ã', 'üêõ', 'üêú',
        'üåà', '‚òÄÔ∏è', '‚õÖ', '‚òÅÔ∏è', 'üå§', 'üå¶', 'üåß', '‚õà', 'üå©', '‚ùÑÔ∏è',
        'üíß', 'üí¶', 'üí®', 'üåä', 'üçÄ', 'üåæ', 'üåø', 'üçÉ', 'üå±', 'üåµ'
      ];
      let html = '<div class="sticker-grid">';
      stickers.forEach(s => {
        html += `<div class="sticker-item" onclick="addSticker('${s}')">${s}</div>`;
      });
      html += '</div>';
      panelContent.innerHTML = html;
    }
    else if(tab === 'tools') {
      panelContent.innerHTML = `
        <div class="tool-grid">
          <div class="tool-item" onclick="document.execCommand('undo')"><i class="fas fa-undo"></i><span>Undo</span></div>
          <div class="tool-item" onclick="document.execCommand('redo')"><i class="fas fa-redo"></i><span>Redo</span></div>
          <div class="tool-item" onclick="exportNote()"><i class="fas fa-file-export"></i><span>Export</span></div>
          <div class="tool-item" onclick="countWords()"><i class="fas fa-calculator"></i><span>Word Count</span></div>
          <div class="tool-item" onclick="setMood()"><i class="far fa-smile"></i><span>Mood</span></div>
        </div>
      `;
    }
  }

  // --- EDITOR UTILS ---
  function execCmd(cmd, val=null) {
    document.execCommand(cmd, false, val);
    richEditor.focus();
    autoSave();
    // Close panel if simple command
    if(cmd !== 'insertImage' && cmd !== 'fontSize' && cmd !== 'fontName') closePanel();
  }

  function setFont(name) {
    document.execCommand('fontName', false, name);
    closePanel();
  }

  function insertImagePrompt() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = e => {
      const file = e.target.files[0];
      if(file) {
        const reader = new FileReader();
        reader.onload = r => {
          document.execCommand('insertImage', false, r.target.result);
          closePanel();
        };
        reader.readAsDataURL(file);
      }
    };
    input.click();
  }

  function insertCheckbox() {
    const html = '<input type="checkbox" style="margin-right:8px; pointer-events:none;">&nbsp;';
    document.execCommand('insertHTML', false, html);
    closePanel();
  }

  function insertQuote() {
    const html = '<blockquote style="border-left:4px solid #8ecf9a; margin:10px 0; padding-left:10px; font-style:italic; color:#666;">Kutipan...</blockquote><br>';
    document.execCommand('insertHTML', false, html);
    closePanel();
  }

  function applyTheme(id) {
    currentNote.theme = id;
    const t = {
      'default': {font:'Quicksand', col:'#333', paper:'#fffaf0'},
      'sakura': {font:'Caveat', col:'#c56582', paper:'#fff0f5'},
      'sky': {font:'Nunito', col:'#333', paper:'#f0f8ff'},
      'sunshine': {font:'Baloo 2', col:'#5d4037', paper:'#fffbea'}
    }[id];

    richEditor.style.fontFamily = t.font;
    richEditor.style.color = t.col;
    paperContainer.style.background = t.paper;
    autoSave();
    closePanel();
  }
  
  function setTheme(id) {
    // Helper to just set style without saving (for loading)
    const t = {
      'default': {font:'Quicksand', col:'#333', paper:'#fffaf0'},
      'sakura': {font:'Caveat', col:'#c56582', paper:'#fff0f5'},
      'sky': {font:'Nunito', col:'#333', paper:'#f0f8ff'},
      'sunshine': {font:'Baloo 2', col:'#5d4037', paper:'#fffbea'}
    }[id] || {font:'Quicksand', col:'#333', paper:'#fffaf0'};

    richEditor.style.fontFamily = t.font;
    richEditor.style.color = t.col;
    paperContainer.style.background = t.paper;
  }

  function setPaper(type) {
    currentNote.paperType = type;
    const color = 'rgba(0,0,0,0.05)';
    let bg = '';
    
    if(type === 'plain') bg = 'none';
    if(type === 'lines') bg = `repeating-linear-gradient(transparent, transparent 31px, ${color} 31px, ${color} 32px)`;
    if(type === 'grid') bg = `linear-gradient(${color} 1px, transparent 1px), linear-gradient(90deg, ${color} 1px, transparent 1px)`;
    
    paperPattern.style.backgroundImage = bg;
    paperPattern.style.backgroundSize = type === 'grid' ? '20px 20px' : '100% 32px';
    
    autoSave();
    closePanel();
  }

  function toggleAlign() {
    const aligns = ['justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull'];
    const icons = ['fa-align-left', 'fa-align-center', 'fa-align-right', 'fa-align-justify'];
    
    // Simple toggle logic
    let curr = parseInt($('alignBtn').dataset.idx || 0);
    let next = (curr + 1) % 4;
    
    document.execCommand(aligns[next]);
    $('alignBtn').dataset.idx = next;
    $('alignBtn').innerHTML = `<i class="fas ${icons[next]}"></i>`;
  }
  
  function toggleFullscreen() {
    if(!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
    closePanel();
  }
  
  function countWords() {
    const txt = richEditor.innerText || "";
    const count = txt.trim().split(/\s+/).length;
    alert(`Jumlah kata: ${txt.trim() === '' ? 0 : count}`);
    closePanel();
  }
  
  function setMood() {
    const m = prompt("Set mood hari ini (emoji):", currentNote.mood || "üåø");
    if(m) {
      currentNote.mood = m;
      autoSave();
    }
    closePanel();
  }
  
  function exportNote() {
    const blob = new Blob([currentNote.content], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = (currentNote.title || 'note') + '.html';
    a.click();
    closePanel();
  }

  function debounce(fn, delay) {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), delay);
    }
  }
</script>
</body>
</html>
